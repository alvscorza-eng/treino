<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Treino" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <title>Meu Treino</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #334155;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-right: max(16px, env(safe-area-inset-right));
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      padding-left: max(16px, env(safe-area-inset-left));
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }

    h1, h2 {
      margin: 0 0 12px;
      line-height: 1.2;
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.1rem; color: var(--muted); }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .exercise-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .exercise-weight {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #0b1220;
      color: var(--text);
      font-size: 1rem;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      touch-action: manipulation;
    }

    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-primary { background: var(--accent); color: #052e16; }
    .btn-secondary { background: #334155; color: var(--text); }
    .btn-danger { background: var(--danger); color: #fff; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .muted { color: var(--muted); font-size: 0.9rem; }

    .timer-display {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 8px 0 12px;
      letter-spacing: 1px;
    }

    .timer-inputs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .add-form {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .pill {
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .pill-status-ready {
      border-color: var(--accent);
      background: #123120;
      color: #dcfce7;
    }

    .pill-status-pending {
      border-color: var(--border);
      background: #0b1220;
      color: var(--muted);
    }

    .pill-status-error {
      border-color: var(--danger);
      background: #3f0f16;
      color: #fecaca;
    }

    .day-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .day-btn {
      background: #334155;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .day-btn.active {
      background: var(--accent);
      color: #052e16;
      border-color: var(--accent);
    }

    .block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      background: #0b1220;
    }

    .block-title {
      font-size: 0.98rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .block-meta {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .exercise-meta {
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.3;
    }

    .section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .calendar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 8px;
    }

    .calendar-weekday {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 600;
      padding: 4px 0;
    }

    .calendar-day {
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 46px;
      background: #0b1220;
      color: var(--text);
      font-weight: 600;
      display: grid;
      place-items: center;
      position: relative;
      padding: 4px;
    }

    .calendar-day.empty {
      background: transparent;
      border-style: dashed;
      opacity: 0.35;
    }

    .calendar-day.trained {
      border-color: var(--accent);
      background: #123120;
      color: #dcfce7;
    }

    .calendar-day.today {
      outline: 2px solid #60a5fa;
      outline-offset: 1px;
    }

    .calendar-tag {
      position: absolute;
      right: 4px;
      bottom: 3px;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .retro-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .retro-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b1220;
      padding: 10px;
    }

    .retro-label {
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 4px;
    }

    .retro-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inline-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.75rem;
      color: var(--muted);
      background: #0b1220;
    }

    .exercise-link {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-color: var(--border);
      text-underline-offset: 2px;
    }

    .stack {
      display: grid;
      gap: 8px;
    }

    .exercise-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .series-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn-series {
      background: var(--accent);
      color: #052e16;
      min-width: 120px;
      min-height: 48px;
      font-size: 1rem;
    }

    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #0b1220;
      color: var(--text);
      font-size: 1rem;
      min-height: 44px;
    }

    .library-grid {
      display: grid;
      gap: 10px;
      max-height: 380px;
      overflow: auto;
      padding-right: 2px;
    }

    .hint-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #0b1220;
    }

    @media (max-width: 400px) {
      .row {
        grid-template-columns: 1fr;
      }
      .exercise-weight {
        justify-content: flex-start;
      }
      .retro-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Meu Treino</h1>
      <span class="pill">Salvo no celular automaticamente</span>
      <span id="offlineStatus" class="pill">Offline: verificando...</span>
      <h2>ABCD - 45 minutos</h2>

      <div class="day-selector" id="daySelector" aria-label="Seleção de treino por dia">
        <button class="day-btn" data-day="A" aria-label="Treino A">A</button>
        <button class="day-btn" data-day="B" aria-label="Treino B">B</button>
        <button class="day-btn" data-day="C" aria-label="Treino C">C</button>
        <button class="day-btn" data-day="D" aria-label="Treino D">D</button>
      </div>

      <p id="dayTitle" class="exercise-name"></p>
      <p id="dayFocus" class="muted"></p>
      <div id="exerciseList"></div>

      <div class="section-actions">
        <button id="resetDayBtn" class="btn-secondary">Resetar cargas do treino</button>
        <button id="resetAllBtn" class="btn-danger">Resetar todas as cargas</button>
      </div>
      <p class="muted">Edite os pesos em cada exercício. Salvamento automático.</p>
    </div>

    <div class="card">
      <h2>Timer de descanso</h2>
      <div id="timerDisplay" class="timer-display" role="timer" aria-live="polite" aria-atomic="true">01:30</div>

      <div class="timer-inputs">
        <label for="minutesInput" class="sr-only">Minutos</label>
        <input id="minutesInput" type="text" inputmode="numeric" value="1" title="Minutos" aria-label="Minutos" placeholder="Min" />
        <label for="secondsInput" class="sr-only">Segundos</label>
        <input id="secondsInput" type="text" inputmode="numeric" value="30" title="Segundos" aria-label="Segundos" placeholder="Seg" />
      </div>

      <div class="actions">
        <button id="setTimerBtn" class="btn-secondary">Definir tempo</button>
        <button id="startPauseBtn" class="btn-primary">Iniciar</button>
        <button id="resetTimerBtn" class="btn-danger">Resetar</button>
      </div>
      <div class="actions">
        <button id="notifyPermissionBtn" class="btn-secondary">Ativar notificações</button>
        <button id="scheduleReminderBtn" class="btn-secondary">Lembrete em 60 min</button>
      </div>
      <div id="activeRestBox" class="hint-box" aria-live="polite">
        <div class="exercise-name">Descanso ativo</div>
        <div id="activeRestText" class="muted">Inicie o timer para receber sugestões rápidas de mobilidade e postura.</div>
      </div>
      <p class="muted">Formato: minutos e segundos.</p>
    </div>

    <div class="card">
      <h2>Banco de exercícios</h2>
      <p class="muted">Toque no nome do exercício para abrir no Google Imagens e ver referências de execução.</p>
      <div id="exerciseLibrary" class="library-grid"></div>
    </div>

    <div class="card">
      <h2>Criar exercício personalizado</h2>
      <div class="stack">
        <input id="customExerciseName" type="text" placeholder="Nome do exercício" aria-label="Nome do exercício" />
        <input id="customExerciseMuscles" type="text" placeholder="Músculos foco (ex: Peito, Tríceps)" aria-label="Músculos foco" />
        <input id="customExerciseDesc" type="text" placeholder="Descrição curta da execução" aria-label="Descrição da execução" />
        <input id="customExerciseMedia" type="text" placeholder="URL de vídeo ou GIF" aria-label="URL de vídeo ou GIF" />
        <button id="addCustomExerciseBtn" class="btn-primary">Adicionar ao treino ativo</button>
      </div>
      <p class="muted">Use para incluir exercícios fora das sugestões. Fica salvo no celular.</p>
    </div>

    <div class="card">
      <h2>Calendário de treinos</h2>
      <div class="calendar-head">
        <span id="calendarMonthLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevMonthBtn" class="btn-secondary" aria-label="Mês anterior">◀</button>
          <button id="todayMonthBtn" class="btn-secondary">Hoje</button>
          <button id="nextMonthBtn" class="btn-secondary" aria-label="Próximo mês">▶</button>
        </div>
      </div>
      <div id="calendarGrid" class="calendar-grid" role="grid" aria-label="Calendário de treino"></div>
      <div class="actions">
        <button id="markTodayBtn" class="btn-primary">Marcar treino de hoje</button>
      </div>
      <p class="muted">Toque em um dia para marcar/desmarcar. Salvo automaticamente.</p>
    </div>

    <div class="card">
      <h2>Retrospectiva anual</h2>
      <div class="calendar-head">
        <span id="retroYearLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevYearBtn" class="btn-secondary" aria-label="Ano anterior">◀</button>
          <button id="currentYearBtn" class="btn-secondary">Ano atual</button>
          <button id="nextYearBtn" class="btn-secondary" aria-label="Próximo ano">▶</button>
        </div>
      </div>
      <div id="retroSummary" class="retro-grid"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'meuTreinoCargasV2';
    const ACTIVE_DAY_KEY = 'meuTreinoDiaAtivoV1';
    const TRAINING_HISTORY_KEY = 'meuTreinoHistoricoV1';
    const CUSTOM_EXERCISES_KEY = 'meuTreinoCustomExercisesV1';
    const SERIES_TRACK_KEY = 'meuTreinoSeriesTrackV1';

    const PLANOS = {
      A: {
        titulo: 'Treino A: Pernas Completo',
        foco: 'Quadríceps, posterior e panturrilha. Alta intensidade com supersets e drop set.',
        blocos: [
          {
            titulo: '1) Bloco de Força (Superset) - 4 séries',
            meta: 'Descanso: 60-90s',
            exercicios: [
              { id: 'a_agachamento', nome: 'Agachamento Livre ou Smith', reps: '8-10 reps', nota: 'Carga pesada e boa amplitude.' },
              { id: 'a_extensora', nome: 'Cadeira Extensora', reps: '12-15 reps', nota: 'Drop set na última série.' }
            ]
          },
          {
            titulo: '2) Bloco Posterior (Superset) - 3 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'a_stiff', nome: 'Stiff (halteres ou barra)', reps: '10-12 reps', nota: 'Coluna neutra e descida controlada.' },
              { id: 'a_flexora', nome: 'Mesa Flexora ou Flexora Vertical', reps: '12 reps', nota: 'Foco no alongamento do posterior.' }
            ]
          },
          {
            titulo: '3) Bloco de Pressão - 3 séries',
            meta: 'Descanso: 90s',
            exercicios: [
              { id: 'a_legpress', nome: 'Leg Press 45°', reps: '10 pesada + 10 média + 10 leve', nota: 'Sem descanso nas trocas de carga.' }
            ]
          },
          {
            titulo: '4) Finalização (Superset) - 3 séries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'a_panturrilha_pe', nome: 'Panturrilha em pé', reps: '15-20 reps', nota: '' },
              { id: 'a_adutora', nome: 'Cadeira Adutora', reps: '15 reps', nota: 'Concentração máxima na contração.' }
            ]
          }
        ]
      },
      B: {
        titulo: 'Treino B: Costas, Tríceps e Abs',
        foco: 'Estratégia puxar/empurrar com supersets para densidade e eficiência.',
        blocos: [
          {
            titulo: '1) Os Gigantes (Superset) - 4 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_barra_fixa', nome: 'Barra Fixa ou Graviton', reps: '8-10 reps ou limite', nota: 'Controle total do movimento.' },
              { id: 'b_dips', nome: 'Mergulho nas Paralelas (Dips)', reps: '10-12 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Densidade e Volume (Superset) - 3 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_remada', nome: 'Remada Curvada', reps: '10 reps', nota: 'Esmagar escápulas no pico.' },
              { id: 'b_triceps_testa', nome: 'Tríceps Testa', reps: '12 reps', nota: 'Drop set na 3ª série.' }
            ]
          },
          {
            titulo: '3) Isolamento (Superset) - 3 séries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'b_pulldown_estendido', nome: 'Pulldown com braços estendidos', reps: '15 reps', nota: '' },
              { id: 'b_triceps_corda', nome: 'Tríceps Corda', reps: '12-15 reps', nota: 'Abrir bem a corda no final.' }
            ]
          },
          {
            titulo: '4) Core (Circuito) - 3 voltas',
            meta: 'Descanso: 30s entre voltas',
            exercicios: [
              { id: 'b_elevacao_pernas', nome: 'Elevação de Pernas', reps: '15 reps', nota: '' },
              { id: 'b_reza_cabo', nome: 'Abdominal Reza (cabo)', reps: '15-20 reps', nota: '' },
              { id: 'b_prancha', nome: 'Prancha Isométrica', reps: '45s', nota: '' }
            ]
          }
        ]
      },
      C: {
        titulo: 'Treino C: Peito e Bíceps',
        foco: 'Hipertrofia e densidade muscular.',
        blocos: [
          {
            titulo: '1) Bloco de Volume (Peito) - 4 séries',
            meta: 'Superset sem descanso entre exercícios',
            exercicios: [
              { id: 'c_supino_inclinado', nome: 'Supino Inclinado (Halteres)', reps: '8-10 reps', nota: '' },
              { id: 'c_flexao', nome: 'Flexão de Braço', reps: 'Até a falha', nota: 'Executar logo após o supino.' }
            ]
          },
          {
            titulo: '2) Bloco de Força (Peito) - 3 séries',
            meta: 'Drop set na última série',
            exercicios: [
              { id: 'c_supino_reto', nome: 'Supino Reto (Barra ou Máquina)', reps: '10 reps', nota: 'Reduzir ~30% e ir até falha no final.' }
            ]
          },
          {
            titulo: '3) Isolamento e Pico (Superset) - 3 séries',
            meta: '',
            exercicios: [
              { id: 'c_pec_deck', nome: 'Crucifixo Máquina (Pec Deck)', reps: '12-15 reps', nota: 'Peito estufado no movimento.' },
              { id: 'c_rosca_direta', nome: 'Rosca Direta (Barra W/Reta)', reps: '10-12 reps', nota: 'Evitar balanço de tronco.' }
            ]
          },
          {
            titulo: '4) Finalizador Bíceps - 3 séries',
            meta: '',
            exercicios: [
              { id: 'c_rosca_martelo', nome: 'Rosca Martelo (Halteres)', reps: '12 reps', nota: '' },
              { id: 'c_rosca_concentrada', nome: 'Rosca Concentrada', reps: '10 reps', nota: 'Sem descanso entre braços.' }
            ]
          }
        ]
      },
      D: {
        titulo: 'Treino D: Ombros, Trapézio, Abs e Panturrilhas',
        foco: 'Largura de ombros (V-taper) e finalização de membros inferiores.',
        blocos: [
          {
            titulo: '1) Bloco de Largura (Ombros) - 4 séries',
            meta: '',
            exercicios: [
              { id: 'd_desenvolvimento', nome: 'Desenvolvimento Militar', reps: '8-10 reps', nota: '' },
              { id: 'd_elevacao_lateral', nome: 'Elevação Lateral', reps: '12-15 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Detalhamento (Posterior/Trapézio) - 3 séries',
            meta: 'Drop set no encolhimento na última série',
            exercicios: [
              { id: 'd_posterior', nome: 'Elevação Lateral Inclinado', reps: '12 reps', nota: 'Posterior de ombro.' },
              { id: 'd_encolhimento', nome: 'Encolhimento (halteres/barra)', reps: '15 reps', nota: 'Segurar 2s no topo.' }
            ]
          },
          {
            titulo: '3) Core (Abs) - 3 séries',
            meta: '',
            exercicios: [
              { id: 'd_infra', nome: 'Abdominal Infra', reps: '15-20 reps', nota: 'Movimento lento e controlado.' },
              { id: 'd_supra', nome: 'Abdominal Supra (com peso)', reps: '15 reps', nota: 'Soltar ar no topo da contração.' }
            ]
          },
          {
            titulo: '4) Panturrilha - 4 séries',
            meta: 'Rest-pause na última série',
            exercicios: [
              { id: 'd_panturrilha_pe', nome: 'Panturrilha em pé', reps: '15-20 reps', nota: '' },
              { id: 'd_panturrilha_sentado', nome: 'Panturrilha sentado (cavalinho)', reps: '15 reps', nota: 'Falhou, descansa 10s e continua.' }
            ]
          }
        ]
      }
    };

    const EXERCISE_LIBRARY = [
      { id: 'a_agachamento', nome: 'Agachamento Livre ou Smith', musculos: 'Quadríceps, glúteos, core', descricao: 'Pés firmes e coluna neutra; desça até amplitude segura.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-squat-side.gif' },
      { id: 'a_extensora', nome: 'Cadeira Extensora', musculos: 'Quadríceps', descricao: 'Suba controlando e segure 1s no topo da contração.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-extension-side.gif' },
      { id: 'a_stiff', nome: 'Stiff (halteres ou barra)', musculos: 'Posterior de coxa, glúteos', descricao: 'Quadril para trás, joelhos semi-flexionados e lombar neutra.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-romanian-deadlift-side.gif' },
      { id: 'a_flexora', nome: 'Mesa Flexora ou Flexora Vertical', musculos: 'Posterior de coxa', descricao: 'Evite tirar o quadril do banco e controle a volta.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-curl-side.gif' },
      { id: 'a_legpress', nome: 'Leg Press 45°', musculos: 'Quadríceps, glúteos', descricao: 'Desça até manter lombar estável e empurre sem travar joelhos.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-press-side.gif' },
      { id: 'b_barra_fixa', nome: 'Barra Fixa ou Graviton', musculos: 'Dorsal, bíceps', descricao: 'Puxe com cotovelos para baixo e evite impulso.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Bodyweight-pullup-side.gif' },
      { id: 'b_dips', nome: 'Mergulho nas Paralelas (Dips)', musculos: 'Tríceps, peitoral inferior', descricao: 'Tronco levemente inclinado e descida sob controle.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Bodyweight-dips-side.gif' },
      { id: 'b_remada', nome: 'Remada Curvada', musculos: 'Costas, posterior de ombro', descricao: 'Mantenha o tronco firme e puxe em direção ao abdômen.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-row-side.gif' },
      { id: 'b_triceps_testa', nome: 'Tríceps Testa', musculos: 'Tríceps', descricao: 'Cotovelos fixos e controle da barra/halteres na descida.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-lying-tricep-extension-side.gif' },
      { id: 'c_supino_inclinado', nome: 'Supino Inclinado (Halteres)', musculos: 'Peitoral superior, tríceps', descricao: 'Escápulas encaixadas e subida sem bater halteres.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-incline-bench-press-side.gif' },
      { id: 'c_supino_reto', nome: 'Supino Reto (Barra ou Máquina)', musculos: 'Peitoral, tríceps, ombro anterior', descricao: 'Pés fixos no chão e barra tocando levemente o peito.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-bench-press-side.gif' },
      { id: 'c_pec_deck', nome: 'Crucifixo Máquina (Pec Deck)', musculos: 'Peitoral', descricao: 'Aproxime os braços em arco e volte controlando.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-pec-deck-fly-side.gif' },
      { id: 'c_rosca_direta', nome: 'Rosca Direta (Barra W/Reta)', musculos: 'Bíceps', descricao: 'Cotovelos ao lado do tronco, sem balanço.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-curl-side.gif' },
      { id: 'd_desenvolvimento', nome: 'Desenvolvimento Militar', musculos: 'Ombros, tríceps', descricao: 'Empurre acima da cabeça sem perder estabilidade do core.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-standing-military-press-side.gif' },
      { id: 'd_elevacao_lateral', nome: 'Elevação Lateral', musculos: 'Deltoide lateral', descricao: 'Suba até a linha do ombro com cotovelos semi-flexionados.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-dumbbell-lateral-raise-side.gif' },
      { id: 'd_encolhimento', nome: 'Encolhimento (halteres/barra)', musculos: 'Trapézio', descricao: 'Eleve os ombros para cima e desça controlando.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-dumbbell-shrug-side.gif' },
      { id: 'b_prancha', nome: 'Prancha Isométrica', musculos: 'Core', descricao: 'Alinhe cabeça, tronco e quadril sem compensar lombar.', media: 'https://media.tenor.com/oqfD8WmKu14AAAAC/plank-fitness.gif' }
    ];

    const ACTIVE_REST_TIPS = [
      'Respiração: 4 segundos inspirando pelo nariz e 4 soltando lentamente.',
      'Postura: retraia as escápulas por 15 segundos e relaxe.',
      'Alongue peitoral em uma parede por 20 segundos de cada lado.',
      'Mobilize tornozelos: joelho à frente sem tirar o calcanhar do chão.',
      'Alongamento de flexor do quadril por 20 segundos de cada lado.',
      'Ative o core: contraia abdômen por 10 segundos e solte.'
    ];

    const EXERCISE_LIBRARY_MAP = Object.fromEntries(EXERCISE_LIBRARY.map((exercise) => [exercise.id, exercise]));

    const listEl = document.getElementById('exerciseList');
    const daySelectorEl = document.getElementById('daySelector');
    const dayTitleEl = document.getElementById('dayTitle');
    const dayFocusEl = document.getElementById('dayFocus');
    const resetDayBtn = document.getElementById('resetDayBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    const timerDisplayEl = document.getElementById('timerDisplay');
    const minutesInputEl = document.getElementById('minutesInput');
    const secondsInputEl = document.getElementById('secondsInput');
    const setTimerBtn = document.getElementById('setTimerBtn');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');
    const notifyPermissionBtn = document.getElementById('notifyPermissionBtn');
    const scheduleReminderBtn = document.getElementById('scheduleReminderBtn');
    const activeRestTextEl = document.getElementById('activeRestText');

    const exerciseLibraryEl = document.getElementById('exerciseLibrary');

    const customExerciseNameEl = document.getElementById('customExerciseName');
    const customExerciseMusclesEl = document.getElementById('customExerciseMuscles');
    const customExerciseDescEl = document.getElementById('customExerciseDesc');
    const customExerciseMediaEl = document.getElementById('customExerciseMedia');
    const addCustomExerciseBtn = document.getElementById('addCustomExerciseBtn');

    const calendarMonthLabelEl = document.getElementById('calendarMonthLabel');
    const calendarGridEl = document.getElementById('calendarGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const todayMonthBtn = document.getElementById('todayMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const markTodayBtn = document.getElementById('markTodayBtn');

    const retroYearLabelEl = document.getElementById('retroYearLabel');
    const retroSummaryEl = document.getElementById('retroSummary');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const currentYearBtn = document.getElementById('currentYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    const offlineStatusEl = document.getElementById('offlineStatus');

    let cargas = loadCargas();
    let activeDay = loadActiveDay();
    let trainingHistory = loadTrainingHistory();
    let customExercisesByDay = loadCustomExercises();
    let seriesTrackByDate = loadSeriesTrack();

    const today = new Date();
    let calendarYear = today.getFullYear();
    let calendarMonth = today.getMonth();
    let retrospectiveYear = today.getFullYear();

    let totalSeconds = 90;
    let remainingSeconds = totalSeconds;
    let timerId = null;
    let reminderTimeoutId = null;

    function loadCargas() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch {
        return {};
      }
    }

    function saveCargas() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cargas));
    }

    function loadActiveDay() {
      const saved = localStorage.getItem(ACTIVE_DAY_KEY);
      if (saved && PLANOS[saved]) return saved;
      return 'A';
    }

    function saveActiveDay() {
      localStorage.setItem(ACTIVE_DAY_KEY, activeDay);
    }

    function loadTrainingHistory() {
      try {
        const raw = localStorage.getItem(TRAINING_HISTORY_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};

        const cleaned = {};
        Object.entries(parsed).forEach(([dateKey, dayValue]) => {
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateKey) && typeof dayValue === 'string' && PLANOS[dayValue]) {
            cleaned[dateKey] = dayValue;
          }
        });
        return cleaned;
      } catch {
        return {};
      }
    }

    function saveTrainingHistory() {
      localStorage.setItem(TRAINING_HISTORY_KEY, JSON.stringify(trainingHistory));
    }

    function loadCustomExercises() {
      try {
        const raw = localStorage.getItem(CUSTOM_EXERCISES_KEY);
        if (!raw) return { A: [], B: [], C: [], D: [] };
        const parsed = JSON.parse(raw);
        const base = { A: [], B: [], C: [], D: [] };
        Object.keys(base).forEach((day) => {
          const list = Array.isArray(parsed?.[day]) ? parsed[day] : [];
          base[day] = list
            .filter((item) => item && typeof item.id === 'string' && typeof item.nome === 'string')
            .map((item) => ({
              id: item.id,
              nome: item.nome,
              reps: typeof item.reps === 'string' ? item.reps : '10-12 reps',
              nota: typeof item.nota === 'string' ? item.nota : '',
              musculos: typeof item.musculos === 'string' ? item.musculos : '',
              descricao: typeof item.descricao === 'string' ? item.descricao : '',
              media: typeof item.media === 'string' ? item.media : ''
            }));
        });
        return base;
      } catch {
        return { A: [], B: [], C: [], D: [] };
      }
    }

    function saveCustomExercises() {
      localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(customExercisesByDay));
    }

    function loadSeriesTrack() {
      try {
        const raw = localStorage.getItem(SERIES_TRACK_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch {
        return {};
      }
    }

    function saveSeriesTrack() {
      localStorage.setItem(SERIES_TRACK_KEY, JSON.stringify(seriesTrackByDate));
    }

    function toDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateKey(dateKey) {
      const [year, month, day] = dateKey.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatMonthYear(year, month) {
      return new Intl.DateTimeFormat('pt-BR', {
        month: 'long',
        year: 'numeric'
      }).format(new Date(year, month, 1));
    }

    function markTraining(dateKey, day) {
      trainingHistory[dateKey] = day;
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
    }

    function toggleTraining(dateKey) {
      if (trainingHistory[dateKey]) {
        delete trainingHistory[dateKey];
      } else {
        trainingHistory[dateKey] = activeDay;
      }
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
    }

    function renderCalendar() {
      calendarGridEl.innerHTML = '';
      calendarMonthLabelEl.textContent = formatMonthYear(calendarYear, calendarMonth);

      const weekdays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
      weekdays.forEach((name) => {
        const weekdayEl = document.createElement('div');
        weekdayEl.className = 'calendar-weekday';
        weekdayEl.textContent = name;
        calendarGridEl.appendChild(weekdayEl);
      });

      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      const startOffset = (firstDay.getDay() + 6) % 7;
      const todayKey = toDateKey(new Date());

      for (let i = 0; i < startOffset; i += 1) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        empty.setAttribute('aria-hidden', 'true');
        calendarGridEl.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day += 1) {
        const currentDate = new Date(calendarYear, calendarMonth, day);
        const dateKey = toDateKey(currentDate);
        const trainedDay = trainingHistory[dateKey];

        const dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className = 'calendar-day';
        dayBtn.dataset.date = dateKey;
        dayBtn.setAttribute('aria-label', trainedDay
          ? `${day} treinado (${trainedDay})`
          : `${day} sem treino marcado`);
        dayBtn.textContent = day;

        if (trainedDay) {
          dayBtn.classList.add('trained');
          const tag = document.createElement('span');
          tag.className = 'calendar-tag';
          tag.textContent = trainedDay;
          dayBtn.appendChild(tag);
        }

        if (dateKey === todayKey) {
          dayBtn.classList.add('today');
        }

        calendarGridEl.appendChild(dayBtn);
      }
    }

    function calculateStreaks(dateKeys) {
      if (!dateKeys.length) {
        return { longest: 0, latest: 0 };
      }

      let longest = 1;
      let current = 1;

      for (let i = 1; i < dateKeys.length; i += 1) {
        const prevDate = parseDateKey(dateKeys[i - 1]);
        const currentDate = parseDateKey(dateKeys[i]);
        const diffDays = Math.round((currentDate - prevDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          current += 1;
          if (current > longest) longest = current;
        } else {
          current = 1;
        }
      }

      return { longest, latest: current };
    }

    function createRetroItem(label, value) {
      const item = document.createElement('div');
      item.className = 'retro-item';

      const labelEl = document.createElement('div');
      labelEl.className = 'retro-label';
      labelEl.textContent = label;

      const valueEl = document.createElement('div');
      valueEl.className = 'retro-value';
      valueEl.textContent = value;

      item.append(labelEl, valueEl);
      return item;
    }

    function renderRetrospective() {
      retroSummaryEl.innerHTML = '';
      retroYearLabelEl.textContent = `Ano ${retrospectiveYear}`;

      const filteredEntries = Object.entries(trainingHistory)
        .filter(([dateKey]) => dateKey.startsWith(`${retrospectiveYear}-`))
        .sort(([a], [b]) => a.localeCompare(b));

      if (!filteredEntries.length) {
        retroSummaryEl.appendChild(createRetroItem('Resumo', 'Sem treinos neste ano'));
        return;
      }

      const total = filteredEntries.length;
      const monthCounts = Array(12).fill(0);
      const dayCounts = { A: 0, B: 0, C: 0, D: 0 };

      filteredEntries.forEach(([dateKey, day]) => {
        const parsedDate = parseDateKey(dateKey);
        monthCounts[parsedDate.getMonth()] += 1;
        if (dayCounts[day] !== undefined) dayCounts[day] += 1;
      });

      const bestMonthCount = Math.max(...monthCounts);
      const bestMonthIndex = monthCounts.indexOf(bestMonthCount);
      const bestMonthName = new Intl.DateTimeFormat('pt-BR', { month: 'long' })
        .format(new Date(retrospectiveYear, bestMonthIndex, 1));

      const streaks = calculateStreaks(filteredEntries.map(([dateKey]) => dateKey));
      const favoriteDay = Object.entries(dayCounts).sort((a, b) => b[1] - a[1])[0];

      retroSummaryEl.appendChild(createRetroItem('Treinos totais', String(total)));
      retroSummaryEl.appendChild(createRetroItem('Média mensal', (total / 12).toFixed(1)));
      retroSummaryEl.appendChild(createRetroItem('Melhor mês', `${bestMonthName} (${bestMonthCount})`));
      retroSummaryEl.appendChild(createRetroItem('Maior sequência', `${streaks.longest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Sequência recente', `${streaks.latest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Treino mais feito', `${favoriteDay[0]} (${favoriteDay[1]})`));
    }

    function getCombinedExercises(day) {
      const baseBlocks = PLANOS[day].blocos;
      const customList = customExercisesByDay[day] || [];
      if (!customList.length) return baseBlocks;

      return [
        ...baseBlocks,
        {
          titulo: '5) Personalizados',
          meta: 'Exercícios adicionados por você',
          exercicios: customList
        }
      ];
    }

    function getExerciseDetails(exercise) {
      const fromLibrary = EXERCISE_LIBRARY_MAP[exercise.id] || EXERCISE_LIBRARY.find((item) => item.nome === exercise.nome);
      return {
        musculos: exercise.musculos || fromLibrary?.musculos || '',
        descricao: exercise.descricao || fromLibrary?.descricao || exercise.nota || '',
        media: exercise.media || fromLibrary?.media || ''
      };
    }

    function openGoogleImagesSearch(exerciseName) {
      const query = encodeURIComponent(exerciseName);
      window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank', 'noopener,noreferrer');
    }

    function setOfflineStatus(text, state = 'pending') {
      offlineStatusEl.textContent = text;
      offlineStatusEl.classList.remove('pill-status-ready', 'pill-status-pending', 'pill-status-error');

      if (state === 'ready') {
        offlineStatusEl.classList.add('pill-status-ready');
      } else if (state === 'error') {
        offlineStatusEl.classList.add('pill-status-error');
      } else {
        offlineStatusEl.classList.add('pill-status-pending');
      }
    }

    async function requestOfflineStatusFromServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        setOfflineStatus('Offline: sem suporte', 'error');
        return;
      }

      const controller = navigator.serviceWorker.controller;
      if (!controller) {
        setOfflineStatus(navigator.onLine ? 'Offline: preparando...' : 'Offline: indisponível', navigator.onLine ? 'pending' : 'error');
        return;
      }

      const channel = new MessageChannel();
      const timeoutId = setTimeout(() => {
        setOfflineStatus(navigator.onLine ? 'Offline: verificando...' : 'Offline: sem cache', navigator.onLine ? 'pending' : 'error');
      }, 1500);

      channel.port1.onmessage = (event) => {
        clearTimeout(timeoutId);
        if (event.data?.type === 'CACHE_STATUS') {
          if (event.data.ready) {
            setOfflineStatus('Offline: pronto', 'ready');
          } else {
            setOfflineStatus(navigator.onLine ? 'Offline: preparando...' : 'Offline: sem cache', navigator.onLine ? 'pending' : 'error');
          }
        }
      };

      controller.postMessage({ type: 'GET_CACHE_STATUS' }, [channel.port2]);
    }

    function getSeriesCount(exerciseId) {
      const todayKey = toDateKey(new Date());
      return Number(seriesTrackByDate?.[todayKey]?.[exerciseId] || 0);
    }

    function markSeries(exerciseId) {
      const todayKey = toDateKey(new Date());
      if (!seriesTrackByDate[todayKey]) {
        seriesTrackByDate[todayKey] = {};
      }
      const current = Number(seriesTrackByDate[todayKey][exerciseId] || 0);
      seriesTrackByDate[todayKey][exerciseId] = current + 1;
      saveSeriesTrack();
      renderExercises();
    }

    function buildCustomExerciseFromInput() {
      const nome = customExerciseNameEl.value.trim();
      const musculos = customExerciseMusclesEl.value.trim();
      const descricao = customExerciseDescEl.value.trim();
      const media = customExerciseMediaEl.value.trim();

      if (!nome) return null;

      return {
        id: `custom_${Date.now()}`,
        nome,
        reps: '10-12 reps',
        nota: '',
        musculos,
        descricao,
        media
      };
    }

    function addExerciseToActiveDay(exercise) {
      const day = activeDay;
      customExercisesByDay[day].push(exercise);
      saveCustomExercises();
      renderExercises();
    }

    function renderExerciseLibrary() {
      exerciseLibraryEl.innerHTML = '';

      EXERCISE_LIBRARY.forEach((exercise) => {
        const card = document.createElement('div');
        card.className = 'block';

        const name = document.createElement('div');
        name.className = 'exercise-name';
        name.textContent = exercise.nome;
        name.classList.add('exercise-link');
        name.title = 'Abrir no Google Imagens';
        name.addEventListener('click', () => openGoogleImagesSearch(exercise.nome));

        const muscles = document.createElement('div');
        muscles.className = 'inline-chip';
        muscles.textContent = exercise.musculos;

        const description = document.createElement('div');
        description.className = 'exercise-meta';
        description.textContent = exercise.descricao;

        const actions = document.createElement('div');
        actions.className = 'exercise-actions';

        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'btn-secondary';
        addButton.textContent = `Adicionar ao treino ${activeDay}`;
        addButton.addEventListener('click', () => {
          addExerciseToActiveDay({
            id: `custom_${exercise.id}_${Date.now()}`,
            nome: exercise.nome,
            reps: '10-12 reps',
            nota: '',
            musculos: exercise.musculos,
            descricao: exercise.descricao,
            media: exercise.media
          });
        });

        actions.appendChild(addButton);
        card.append(name, muscles, description, actions);
        exerciseLibraryEl.appendChild(card);
      });
    }

    function setActiveRestTip(randomize = true) {
      const tip = randomize
        ? ACTIVE_REST_TIPS[Math.floor(Math.random() * ACTIVE_REST_TIPS.length)]
        : ACTIVE_REST_TIPS[0];
      activeRestTextEl.textContent = tip;
    }

    async function requestNotificationPermission() {
      if (!('Notification' in window)) return 'unsupported';
      if (Notification.permission === 'granted') return 'granted';
      const result = await Notification.requestPermission();
      return result;
    }

    function notifySmart(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: './icon.svg', badge: './icon.svg' });
      }
      if ('vibrate' in navigator) {
        navigator.vibrate([220, 120, 220]);
      }
    }

    function renderExercises() {
      listEl.innerHTML = '';
      const plano = PLANOS[activeDay];
      const blocks = getCombinedExercises(activeDay);

      dayTitleEl.textContent = plano.titulo;
      dayFocusEl.textContent = plano.foco;
      markTodayBtn.textContent = `Marcar treino de hoje (${activeDay})`;

      daySelectorEl.querySelectorAll('button').forEach((btn) => {
        const isActive = btn.dataset.day === activeDay;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });

      blocks.forEach((bloco) => {
        const blocoEl = document.createElement('div');
        blocoEl.className = 'block';

        const tituloEl = document.createElement('div');
        tituloEl.className = 'block-title';
        tituloEl.textContent = bloco.titulo;

        const metaEl = document.createElement('div');
        metaEl.className = 'block-meta';
        metaEl.textContent = bloco.meta;

        blocoEl.appendChild(tituloEl);
        blocoEl.appendChild(metaEl);

        bloco.exercicios.forEach((exercise) => {
          const details = getExerciseDetails(exercise);
          const row = document.createElement('div');
          row.className = 'row';

          const left = document.createElement('div');
          const name = document.createElement('div');
          name.className = 'exercise-name';
          name.textContent = exercise.nome;
          name.classList.add('exercise-link');
          name.title = 'Abrir no Google Imagens';
          name.addEventListener('click', () => openGoogleImagesSearch(exercise.nome));

          const meta = document.createElement('div');
          meta.className = 'exercise-meta';
          const descriptionText = details.descricao || exercise.nota;
          meta.textContent = `${exercise.reps}${descriptionText ? ` • ${descriptionText}` : ''}`;

          const muscles = document.createElement('div');
          muscles.className = 'inline-chip';
          muscles.textContent = details.musculos || 'Músculos gerais';

          const seriesRow = document.createElement('div');
          seriesRow.className = 'series-row';

          const seriesBadge = document.createElement('span');
          seriesBadge.className = 'muted';
          seriesBadge.textContent = `Séries hoje: ${getSeriesCount(exercise.id)}`;

          const seriesButton = document.createElement('button');
          seriesButton.type = 'button';
          seriesButton.className = 'btn-series';
          seriesButton.textContent = '+ Marcar série';
          seriesButton.setAttribute('aria-label', `Marcar uma série em ${exercise.nome}`);
          seriesButton.addEventListener('click', () => markSeries(exercise.id));

          seriesRow.append(seriesButton, seriesBadge);

          left.append(name, muscles, meta, seriesRow);

          const right = document.createElement('div');
          right.className = 'exercise-weight';

          const weightInput = document.createElement('input');
          weightInput.type = 'number';
          weightInput.min = '0';
          weightInput.step = '0.5';
          weightInput.inputMode = 'decimal';
          weightInput.setAttribute('aria-label', `Carga em kg para ${exercise.nome}`);
          weightInput.style.width = '90px';
          weightInput.value = typeof cargas[exercise.id] === 'number' ? cargas[exercise.id] : 0;
          weightInput.addEventListener('input', () => {
            const value = Number(weightInput.value);
            cargas[exercise.id] = Number.isNaN(value) ? 0 : value;
            saveCargas();
          });

          const kg = document.createElement('span');
          kg.textContent = 'kg';
          kg.className = 'muted';

          right.append(weightInput, kg);
          row.append(left, right);
          blocoEl.appendChild(row);
        });

        listEl.appendChild(blocoEl);
      });
    }

    function resetCurrentDayLoads() {
      const blocos = getCombinedExercises(activeDay);
      blocos.forEach((bloco) => {
        bloco.exercicios.forEach((exercise) => {
          cargas[exercise.id] = 0;
        });
      });
      saveCargas();
      renderExercises();
    }

    function resetAllLoads() {
      cargas = {};
      saveCargas();
      renderExercises();
    }

    daySelectorEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-day]');
      if (!button) return;
      activeDay = button.dataset.day;
      saveActiveDay();
      renderExercises();
      renderExerciseLibrary();
    });

    resetDayBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas apenas do treino atual?')) {
        resetCurrentDayLoads();
      }
    });

    resetAllBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas de todos os treinos?')) {
        resetAllLoads();
      }
    });

    addCustomExerciseBtn.addEventListener('click', () => {
      const customExercise = buildCustomExerciseFromInput();
      if (!customExercise) {
        customExerciseNameEl.focus();
        return;
      }

      addExerciseToActiveDay(customExercise);
      customExerciseNameEl.value = '';
      customExerciseMusclesEl.value = '';
      customExerciseDescEl.value = '';
      customExerciseMediaEl.value = '';
    });

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60).toString().padStart(2, '0');
      const sec = (seconds % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function updateTimerDisplay() {
      timerDisplayEl.textContent = formatTime(remainingSeconds);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      startPauseBtn.textContent = 'Iniciar';
    }

    function startTimer() {
      if (remainingSeconds <= 0) return;
      setActiveRestTip(true);
      timerId = setInterval(() => {
        remainingSeconds -= 1;
        updateTimerDisplay();

        if (remainingSeconds > 0 && remainingSeconds % 20 === 0) {
          setActiveRestTip(true);
        }

        if (remainingSeconds <= 0) {
          stopTimer();
          notifySmart('Descanso finalizado', 'Hora da próxima série.');
        }
      }, 1000);
      startPauseBtn.textContent = 'Pausar';
    }

    setTimerBtn.addEventListener('click', () => {
      const minuteStr = (minutesInputEl.value || '0').trim();
      const secondStr = (secondsInputEl.value || '0').trim();
      
      const parsedMinutes = parseInt(minuteStr, 10);
      const parsedSeconds = parseInt(secondStr, 10);

      const minutes = !isNaN(parsedMinutes)
        ? Math.max(0, Math.min(59, parsedMinutes))
        : 0;
      const seconds = !isNaN(parsedSeconds)
        ? Math.max(0, Math.min(59, parsedSeconds))
        : 0;

      totalSeconds = minutes * 60 + seconds;
      if (totalSeconds === 0) totalSeconds = 60;
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
    })

    startPauseBtn.addEventListener('click', () => {
      if (timerId) {
        stopTimer();
      } else {
        startTimer();
      }
    });

    resetTimerBtn.addEventListener('click', () => {
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
      setActiveRestTip(false);
    });

    notifyPermissionBtn.addEventListener('click', async () => {
      const permission = await requestNotificationPermission();
      if (permission === 'granted') {
        notifyPermissionBtn.textContent = 'Notificações ativadas';
        notifySmart('Notificações ativas', 'Você receberá alertas do timer e lembretes.');
      } else if (permission === 'denied') {
        notifyPermissionBtn.textContent = 'Notificações bloqueadas';
      } else if (permission === 'unsupported') {
        notifyPermissionBtn.textContent = 'Sem suporte no navegador';
      }
    });

    scheduleReminderBtn.addEventListener('click', async () => {
      if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
      }

      await requestNotificationPermission();

      reminderTimeoutId = setTimeout(() => {
        notifySmart('Lembrete de treino', 'Hora de treinar. Se já treinou, ótimo trabalho 💪');
      }, 60 * 60 * 1000);

      scheduleReminderBtn.textContent = 'Lembrete agendado';
    });

    calendarGridEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-date]');
      if (!button) return;
      toggleTraining(button.dataset.date);
    });

    prevMonthBtn.addEventListener('click', () => {
      calendarMonth -= 1;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear -= 1;
      }
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      calendarMonth += 1;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear += 1;
      }
      renderCalendar();
    });

    todayMonthBtn.addEventListener('click', () => {
      const now = new Date();
      calendarYear = now.getFullYear();
      calendarMonth = now.getMonth();
      renderCalendar();
    });

    markTodayBtn.addEventListener('click', () => {
      markTraining(toDateKey(new Date()), activeDay);
    });

    prevYearBtn.addEventListener('click', () => {
      retrospectiveYear -= 1;
      renderRetrospective();
    });

    nextYearBtn.addEventListener('click', () => {
      retrospectiveYear += 1;
      renderRetrospective();
    });

    currentYearBtn.addEventListener('click', () => {
      retrospectiveYear = new Date().getFullYear();
      renderRetrospective();
    });

    renderExercises();
    renderExerciseLibrary();
    setActiveRestTip(false);
    updateTimerDisplay();
    renderCalendar();
    renderRetrospective();

    window.addEventListener('online', () => {
      requestOfflineStatusFromServiceWorker();
    });

    window.addEventListener('offline', () => {
      requestOfflineStatusFromServiceWorker();
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(() => {
          requestOfflineStatusFromServiceWorker();
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        requestOfflineStatusFromServiceWorker();
      });
    } else {
      setOfflineStatus('Offline: sem suporte', 'error');
    }
  </script>
</body>
</html>
