<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta id="themeColorMeta" name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Treino" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <title>Meu Treino</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #334155;
      --surface: #0b1220;
      --focus: #60a5fa;
      --btn-secondary-bg: #334155;
      --btn-secondary-text: #f8fafc;
    }

    body[data-theme="light"] {
      --bg: #e2e8f0;
      --card: #f8fafc;
      --text: #0f172a;
      --muted: #475569;
      --accent: #16a34a;
      --danger: #dc2626;
      --border: #cbd5e1;
      --surface: #ffffff;
      --focus: #2563eb;
      --btn-secondary-bg: #e2e8f0;
      --btn-secondary-text: #0f172a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-right: max(16px, env(safe-area-inset-right));
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      padding-left: max(16px, env(safe-area-inset-left));
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }

    h1, h2 {
      margin: 0 0 12px;
      line-height: 1.2;
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.1rem; color: var(--muted); }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .exercise-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .exercise-weight {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: var(--surface);
      color: var(--text);
      font-size: 16px;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 48px;
      touch-action: manipulation;
    }

    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-primary { background: var(--accent); color: #052e16; }
    .btn-secondary { background: var(--btn-secondary-bg); color: var(--btn-secondary-text); }
    .btn-danger { background: var(--danger); color: #fff; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .muted { color: var(--muted); font-size: 0.9rem; }

    .timer-display {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 8px 0 12px;
      letter-spacing: 1px;
    }

    .timer-inputs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .add-form {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .pill {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .pill-status-ready {
      border-color: var(--accent);
      background: #123120;
      color: #dcfce7;
    }

    .pill-status-pending {
      border-color: var(--border);
      background: var(--surface);
      color: var(--muted);
    }

    .pill-status-error {
      border-color: var(--danger);
      background: #3f0f16;
      color: #fecaca;
    }

    .day-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .day-btn {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-text);
      border: 1px solid var(--border);
    }

    .day-btn.active {
      background: var(--accent);
      color: #052e16;
      border-color: var(--accent);
    }

    .block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      background: var(--surface);
    }

    .block-title {
      font-size: 0.98rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .block-meta {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .exercise-meta {
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.3;
    }

    .section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .calendar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 8px;
    }

    .calendar-weekday {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 600;
      padding: 4px 0;
    }

    .calendar-day {
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 46px;
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      display: grid;
      place-items: center;
      position: relative;
      padding: 4px;
    }

    .calendar-day.empty {
      background: transparent;
      border-style: dashed;
      opacity: 0.35;
    }

    .calendar-day.trained {
      border-color: var(--accent);
      background: #123120;
      color: #dcfce7;
    }

    .calendar-day.today {
      outline: 2px solid var(--focus);
      outline-offset: 1px;
    }

    body[data-theme="light"] .calendar-day.trained,
    body[data-theme="light"] .exercise-current,
    body[data-theme="light"] .pill-status-ready {
      background: #dcfce7;
      color: #166534;
    }

    .calendar-tag {
      position: absolute;
      right: 4px;
      bottom: 3px;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .retro-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .retro-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface);
      padding: 10px;
    }

    .retro-label {
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 4px;
    }

    .retro-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .inline-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 0.75rem;
      color: var(--muted);
      background: var(--surface);
    }

    .exercise-link {
      cursor: pointer;
      text-decoration: underline;
      text-decoration-color: var(--border);
      text-underline-offset: 2px;
    }

    .stack {
      display: grid;
      gap: 8px;
    }

    .exercise-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .series-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .btn-series {
      background: var(--accent);
      color: #052e16;
      min-width: 120px;
      min-height: 48px;
      font-size: 1rem;
    }

    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: var(--surface);
      color: var(--text);
      font-size: 16px;
      min-height: 44px;
    }

    .library-grid {
      display: grid;
      gap: 10px;
      max-height: 380px;
      overflow: auto;
      padding-right: 2px;
    }

    .hint-box {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: var(--surface);
    }

    .progress-track {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #0f172a;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.2s ease;
    }

    .workout-status {
      margin-bottom: 12px;
    }

    .session-status {
      margin: 8px 0;
    }

    .exercise-current {
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 8px;
      background: #123120;
    }

    .pr-meta {
      margin-top: 4px;
    }

    .backup-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .top-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 6px 0 10px;
    }

    .coach-box {
      margin-top: 8px;
    }

    .week-grid {
      display: grid;
      gap: 6px;
      margin-top: 8px;
    }

    .week-row {
      display: grid;
      grid-template-columns: 52px 1fr auto;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: var(--surface);
    }

    .week-day {
      color: var(--muted);
      font-weight: 700;
      font-size: 0.82rem;
      text-transform: uppercase;
    }

    .library-toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .library-toolbar input {
      flex: 1;
      min-width: 180px;
    }

    .btn-favorite {
      background: var(--btn-secondary-bg);
      color: var(--btn-secondary-text);
      border: 1px solid var(--border);
      min-width: 44px;
    }

    @media (pointer: coarse) {
      .actions,
      .section-actions,
      .exercise-actions,
      .series-row,
      .top-actions {
        gap: 10px;
      }
    }

    @media (max-width: 400px) {
      .row {
        grid-template-columns: 1fr;
      }
      .exercise-weight {
        justify-content: flex-start;
      }
      .retro-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Meu Treino</h1>
      <span class="pill">Salvo no celular automaticamente</span>
      <span id="offlineStatus" class="pill">Offline: verificando...</span>
      <div class="top-actions">
        <button id="themeToggleBtn" class="btn-secondary" type="button">Tema: Escuro</button>
        <button id="shareWorkoutBtn" class="btn-secondary" type="button">Compartilhar resultado</button>
      </div>
      <h2>ABCD - 45 minutos</h2>

      <div class="day-selector" id="daySelector" aria-label="Sele√ß√£o de treino por dia">
        <button class="day-btn" data-day="A" aria-label="Treino A">A</button>
        <button class="day-btn" data-day="B" aria-label="Treino B">B</button>
        <button class="day-btn" data-day="C" aria-label="Treino C">C</button>
        <button class="day-btn" data-day="D" aria-label="Treino D">D</button>
      </div>

      <p id="dayTitle" class="exercise-name"></p>
      <p id="dayFocus" class="muted"></p>
      <div id="workoutStatus" class="hint-box workout-status" aria-live="polite">
        <div id="workoutProgressText" class="exercise-name">Progresso: 0 / 0 s√©ries</div>
        <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-label="Progresso do treino">
          <div id="workoutProgressFill" class="progress-fill"></div>
        </div>
        <div id="nextWorkoutHint" class="muted">Pr√≥ximo treino sugerido: A</div>
        <div id="sessionStatus" class="muted session-status">Sess√£o: inativa</div>
        <div id="smartNudge" class="muted">Consist√™ncia em dia. Continue no ritmo üí™</div>
        <div id="coachQuickBox" class="hint-box coach-box">
          <div class="exercise-name">Coach r√°pido</div>
          <div id="coachQuickText" class="muted">Foco do dia e dica pr√°tica para melhorar sua execu√ß√£o.</div>
        </div>
        <button id="toggleSessionBtn" class="btn-primary" type="button">Iniciar treino</button>
      </div>
      <div id="exerciseList"></div>

      <div class="section-actions">
        <button id="resetDayBtn" class="btn-secondary">Zerar cargas do treino</button>
        <button id="resetAllBtn" class="btn-danger">Zerar todas as cargas</button>
      </div>
      <p class="muted">Edite os pesos em cada exerc√≠cio. Salvamento autom√°tico.</p>
    </div>

    <div class="card">
      <h2>Timer de descanso</h2>
      <div id="timerDisplay" class="timer-display" role="timer" aria-live="polite" aria-atomic="true">01:30</div>

      <div class="timer-inputs">
        <label for="minutesInput" class="sr-only">Minutos</label>
        <input id="minutesInput" type="text" inputmode="numeric" value="1" title="Minutos" aria-label="Minutos" placeholder="Min" />
        <label for="secondsInput" class="sr-only">Segundos</label>
        <input id="secondsInput" type="text" inputmode="numeric" value="30" title="Segundos" aria-label="Segundos" placeholder="Seg" />
      </div>

      <div class="actions">
        <button id="setTimerBtn" class="btn-secondary">Definir tempo</button>
        <button id="startPauseBtn" class="btn-primary">Iniciar</button>
        <button id="resetTimerBtn" class="btn-danger">Reiniciar</button>
      </div>
      <div class="actions">
        <button id="notifyPermissionBtn" class="btn-secondary">Ativar notifica√ß√µes</button>
        <button id="scheduleReminderBtn" class="btn-secondary">Lembrete em 1h</button>
      </div>
      <div id="activeRestBox" class="hint-box" aria-live="polite">
        <div class="exercise-name">Descanso ativo</div>
        <div id="activeRestText" class="muted">Inicie o timer para receber sugest√µes r√°pidas de mobilidade e postura.</div>
      </div>
      <p class="muted">Formato: minutos e segundos.</p>
    </div>

    <div class="card">
      <h2>Banco de exerc√≠cios</h2>
      <p class="muted">Toque no nome do exerc√≠cio para abrir no Google Imagens e ver refer√™ncias de execu√ß√£o.</p>
      <div class="library-toolbar">
        <input id="libraryFilterInput" type="text" placeholder="Filtrar exerc√≠cio ou m√∫sculo" aria-label="Filtrar biblioteca" />
        <button id="toggleFavoritesOnlyBtn" class="btn-secondary" type="button">Ver s√≥ favoritos</button>
      </div>
      <div id="exerciseLibrary" class="library-grid"></div>
    </div>

    <div class="card">
      <h2>Planejamento semanal</h2>
      <div id="weekPlanGrid" class="week-grid"></div>
      <p id="weekPlanHint" class="muted">Sugest√£o semanal baseada no √∫ltimo treino registrado.</p>
    </div>

    <div class="card">
      <h2>Criar exerc√≠cio personalizado</h2>
      <div class="stack">
        <input id="customExerciseName" type="text" placeholder="Nome do exerc√≠cio" aria-label="Nome do exerc√≠cio" />
        <input id="customExerciseMuscles" type="text" placeholder="M√∫sculos foco (ex: Peito, Tr√≠ceps)" aria-label="M√∫sculos foco" />
        <input id="customExerciseDesc" type="text" placeholder="Descri√ß√£o curta da execu√ß√£o" aria-label="Descri√ß√£o da execu√ß√£o" />
        <input id="customExerciseMedia" type="text" placeholder="URL de v√≠deo ou GIF" aria-label="URL de v√≠deo ou GIF" />
        <button id="addCustomExerciseBtn" class="btn-primary">Adicionar ao treino ativo</button>
      </div>
      <p class="muted">Use para incluir exerc√≠cios fora das sugest√µes. Fica salvo no celular.</p>
    </div>

    <div class="card">
      <h2>Calend√°rio de treinos</h2>
      <div class="calendar-head">
        <span id="calendarMonthLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevMonthBtn" class="btn-secondary" aria-label="M√™s anterior">‚óÄ</button>
          <button id="todayMonthBtn" class="btn-secondary">Hoje</button>
          <button id="nextMonthBtn" class="btn-secondary" aria-label="Pr√≥ximo m√™s">‚ñ∂</button>
        </div>
      </div>
      <div id="calendarGrid" class="calendar-grid" role="grid" aria-label="Calend√°rio de treino"></div>
      <div class="actions">
        <button id="markTodayBtn" class="btn-primary">Concluir treino de hoje</button>
      </div>
      <p class="muted">Toque em um dia para marcar/desmarcar. Salvo automaticamente.</p>
    </div>

    <div class="card">
      <h2>Retrospectiva anual</h2>
      <div class="calendar-head">
        <span id="retroYearLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevYearBtn" class="btn-secondary" aria-label="Ano anterior">‚óÄ</button>
          <button id="currentYearBtn" class="btn-secondary">Ano atual</button>
          <button id="nextYearBtn" class="btn-secondary" aria-label="Pr√≥ximo ano">‚ñ∂</button>
        </div>
      </div>
      <div id="retroSummary" class="retro-grid"></div>
    </div>

    <div class="card">
      <h2>Backup e restaura√ß√£o</h2>
      <div class="backup-actions">
        <button id="exportDataBtn" class="btn-secondary">Exportar JSON</button>
        <button id="importDataBtn" class="btn-secondary">Importar JSON</button>
        <input id="importFileInput" type="file" accept="application/json,.json" class="sr-only" aria-label="Selecionar arquivo de backup JSON" />
      </div>
      <p id="backupStatus" class="muted">Exporte para salvar uma c√≥pia e importe quando precisar restaurar.</p>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'meuTreinoCargasV2';
    const ACTIVE_DAY_KEY = 'meuTreinoDiaAtivoV1';
    const TRAINING_HISTORY_KEY = 'meuTreinoHistoricoV1';
    const CUSTOM_EXERCISES_KEY = 'meuTreinoCustomExercisesV1';
    const SERIES_TRACK_KEY = 'meuTreinoSeriesTrackV1';
    const WORKOUT_SET_LOG_KEY = 'meuTreinoSetLogV1';
    const INACTIVITY_ALERT_KEY = 'meuTreinoInactivityAlertV1';
    const FAVORITES_KEY = 'meuTreinoFavoritesV1';
    const THEME_KEY = 'meuTreinoThemeV1';

    const PLANOS = {
      A: {
        titulo: 'Treino A: Pernas Completo',
        foco: 'Quadr√≠ceps, posterior e panturrilha. Alta intensidade com supersets e drop set.',
        blocos: [
          {
            titulo: '1) Bloco de For√ßa (Superset) - 4 s√©ries',
            meta: 'Descanso: 60-90s',
            exercicios: [
              { id: 'a_agachamento', nome: 'Agachamento Livre ou Smith', reps: '8-10 reps', nota: 'Carga pesada e boa amplitude.' },
              { id: 'a_extensora', nome: 'Cadeira Extensora', reps: '12-15 reps', nota: 'Drop set na √∫ltima s√©rie.' }
            ]
          },
          {
            titulo: '2) Bloco Posterior (Superset) - 3 s√©ries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'a_stiff', nome: 'Stiff (halteres ou barra)', reps: '10-12 reps', nota: 'Coluna neutra e descida controlada.' },
              { id: 'a_flexora', nome: 'Mesa Flexora ou Flexora Vertical', reps: '12 reps', nota: 'Foco no alongamento do posterior.' }
            ]
          },
          {
            titulo: '3) Bloco de Press√£o - 3 s√©ries',
            meta: 'Descanso: 90s',
            exercicios: [
              { id: 'a_legpress', nome: 'Leg Press 45¬∞', reps: '10 pesada + 10 m√©dia + 10 leve', nota: 'Sem descanso nas trocas de carga.' }
            ]
          },
          {
            titulo: '4) Finaliza√ß√£o (Superset) - 3 s√©ries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'a_panturrilha_pe', nome: 'Panturrilha em p√©', reps: '15-20 reps', nota: '' },
              { id: 'a_adutora', nome: 'Cadeira Adutora', reps: '15 reps', nota: 'Concentra√ß√£o m√°xima na contra√ß√£o.' }
            ]
          }
        ]
      },
      B: {
        titulo: 'Treino B: Costas, Tr√≠ceps e Abs',
        foco: 'Estrat√©gia puxar/empurrar com supersets para densidade e efici√™ncia.',
        blocos: [
          {
            titulo: '1) Os Gigantes (Superset) - 4 s√©ries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_barra_fixa', nome: 'Barra Fixa ou Graviton', reps: '8-10 reps ou limite', nota: 'Controle total do movimento.' },
              { id: 'b_dips', nome: 'Mergulho nas Paralelas (Dips)', reps: '10-12 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Densidade e Volume (Superset) - 3 s√©ries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_remada', nome: 'Remada Curvada', reps: '10 reps', nota: 'Esmagar esc√°pulas no pico.' },
              { id: 'b_triceps_testa', nome: 'Tr√≠ceps Testa', reps: '12 reps', nota: 'Drop set na 3¬™ s√©rie.' }
            ]
          },
          {
            titulo: '3) Isolamento (Superset) - 3 s√©ries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'b_pulldown_estendido', nome: 'Pulldown com bra√ßos estendidos', reps: '15 reps', nota: '' },
              { id: 'b_triceps_corda', nome: 'Tr√≠ceps Corda', reps: '12-15 reps', nota: 'Abrir bem a corda no final.' }
            ]
          },
          {
            titulo: '4) Core (Circuito) - 3 voltas',
            meta: 'Descanso: 30s entre voltas',
            exercicios: [
              { id: 'b_elevacao_pernas', nome: 'Eleva√ß√£o de Pernas', reps: '15 reps', nota: '' },
              { id: 'b_reza_cabo', nome: 'Abdominal Reza (cabo)', reps: '15-20 reps', nota: '' },
              { id: 'b_prancha', nome: 'Prancha Isom√©trica', reps: '45s', nota: '' }
            ]
          }
        ]
      },
      C: {
        titulo: 'Treino C: Peito e B√≠ceps',
        foco: 'Hipertrofia e densidade muscular.',
        blocos: [
          {
            titulo: '1) Bloco de Volume (Peito) - 4 s√©ries',
            meta: 'Superset sem descanso entre exerc√≠cios',
            exercicios: [
              { id: 'c_supino_inclinado', nome: 'Supino Inclinado (Halteres)', reps: '8-10 reps', nota: '' },
              { id: 'c_flexao', nome: 'Flex√£o de Bra√ßo', reps: 'At√© a falha', nota: 'Executar logo ap√≥s o supino.' }
            ]
          },
          {
            titulo: '2) Bloco de For√ßa (Peito) - 3 s√©ries',
            meta: 'Drop set na √∫ltima s√©rie',
            exercicios: [
              { id: 'c_supino_reto', nome: 'Supino Reto (Barra ou M√°quina)', reps: '10 reps', nota: 'Reduzir ~30% e ir at√© falha no final.' }
            ]
          },
          {
            titulo: '3) Isolamento e Pico (Superset) - 3 s√©ries',
            meta: '',
            exercicios: [
              { id: 'c_pec_deck', nome: 'Crucifixo M√°quina (Pec Deck)', reps: '12-15 reps', nota: 'Peito estufado no movimento.' },
              { id: 'c_rosca_direta', nome: 'Rosca Direta (Barra W/Reta)', reps: '10-12 reps', nota: 'Evitar balan√ßo de tronco.' }
            ]
          },
          {
            titulo: '4) Finalizador B√≠ceps - 3 s√©ries',
            meta: '',
            exercicios: [
              { id: 'c_rosca_martelo', nome: 'Rosca Martelo (Halteres)', reps: '12 reps', nota: '' },
              { id: 'c_rosca_concentrada', nome: 'Rosca Concentrada', reps: '10 reps', nota: 'Sem descanso entre bra√ßos.' }
            ]
          }
        ]
      },
      D: {
        titulo: 'Treino D: Ombros, Trap√©zio, Abs e Panturrilhas',
        foco: 'Largura de ombros (V-taper) e finaliza√ß√£o de membros inferiores.',
        blocos: [
          {
            titulo: '1) Bloco de Largura (Ombros) - 4 s√©ries',
            meta: '',
            exercicios: [
              { id: 'd_desenvolvimento', nome: 'Desenvolvimento Militar', reps: '8-10 reps', nota: '' },
              { id: 'd_elevacao_lateral', nome: 'Eleva√ß√£o Lateral', reps: '12-15 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Detalhamento (Posterior/Trap√©zio) - 3 s√©ries',
            meta: 'Drop set no encolhimento na √∫ltima s√©rie',
            exercicios: [
              { id: 'd_posterior', nome: 'Eleva√ß√£o Lateral Inclinado', reps: '12 reps', nota: 'Posterior de ombro.' },
              { id: 'd_encolhimento', nome: 'Encolhimento (halteres/barra)', reps: '15 reps', nota: 'Segurar 2s no topo.' }
            ]
          },
          {
            titulo: '3) Core (Abs) - 3 s√©ries',
            meta: '',
            exercicios: [
              { id: 'd_infra', nome: 'Abdominal Infra', reps: '15-20 reps', nota: 'Movimento lento e controlado.' },
              { id: 'd_supra', nome: 'Abdominal Supra (com peso)', reps: '15 reps', nota: 'Soltar ar no topo da contra√ß√£o.' }
            ]
          },
          {
            titulo: '4) Panturrilha - 4 s√©ries',
            meta: 'Rest-pause na √∫ltima s√©rie',
            exercicios: [
              { id: 'd_panturrilha_pe', nome: 'Panturrilha em p√©', reps: '15-20 reps', nota: '' },
              { id: 'd_panturrilha_sentado', nome: 'Panturrilha sentado (cavalinho)', reps: '15 reps', nota: 'Falhou, descansa 10s e continua.' }
            ]
          }
        ]
      }
    };

    const EXERCISE_LIBRARY = [
      { id: 'a_agachamento', nome: 'Agachamento Livre ou Smith', musculos: 'Quadr√≠ceps, gl√∫teos, core', descricao: 'P√©s firmes e coluna neutra; des√ßa at√© amplitude segura.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-squat-side.gif' },
      { id: 'a_extensora', nome: 'Cadeira Extensora', musculos: 'Quadr√≠ceps', descricao: 'Suba controlando e segure 1s no topo da contra√ß√£o.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-extension-side.gif' },
      { id: 'a_stiff', nome: 'Stiff (halteres ou barra)', musculos: 'Posterior de coxa, gl√∫teos', descricao: 'Quadril para tr√°s, joelhos semi-flexionados e lombar neutra.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-romanian-deadlift-side.gif' },
      { id: 'a_flexora', nome: 'Mesa Flexora ou Flexora Vertical', musculos: 'Posterior de coxa', descricao: 'Evite tirar o quadril do banco e controle a volta.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-curl-side.gif' },
      { id: 'a_legpress', nome: 'Leg Press 45¬∞', musculos: 'Quadr√≠ceps, gl√∫teos', descricao: 'Des√ßa at√© manter lombar est√°vel e empurre sem travar joelhos.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-leg-press-side.gif' },
      { id: 'b_barra_fixa', nome: 'Barra Fixa ou Graviton', musculos: 'Dorsal, b√≠ceps', descricao: 'Puxe com cotovelos para baixo e evite impulso.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Bodyweight-pullup-side.gif' },
      { id: 'b_dips', nome: 'Mergulho nas Paralelas (Dips)', musculos: 'Tr√≠ceps, peitoral inferior', descricao: 'Tronco levemente inclinado e descida sob controle.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Bodyweight-dips-side.gif' },
      { id: 'b_remada', nome: 'Remada Curvada', musculos: 'Costas, posterior de ombro', descricao: 'Mantenha o tronco firme e puxe em dire√ß√£o ao abd√¥men.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-row-side.gif' },
      { id: 'b_triceps_testa', nome: 'Tr√≠ceps Testa', musculos: 'Tr√≠ceps', descricao: 'Cotovelos fixos e controle da barra/halteres na descida.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-lying-tricep-extension-side.gif' },
      { id: 'c_supino_inclinado', nome: 'Supino Inclinado (Halteres)', musculos: 'Peitoral superior, tr√≠ceps', descricao: 'Esc√°pulas encaixadas e subida sem bater halteres.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-incline-bench-press-side.gif' },
      { id: 'c_supino_reto', nome: 'Supino Reto (Barra ou M√°quina)', musculos: 'Peitoral, tr√≠ceps, ombro anterior', descricao: 'P√©s fixos no ch√£o e barra tocando levemente o peito.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-bench-press-side.gif' },
      { id: 'c_pec_deck', nome: 'Crucifixo M√°quina (Pec Deck)', musculos: 'Peitoral', descricao: 'Aproxime os bra√ßos em arco e volte controlando.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Machine-pec-deck-fly-side.gif' },
      { id: 'c_rosca_direta', nome: 'Rosca Direta (Barra W/Reta)', musculos: 'B√≠ceps', descricao: 'Cotovelos ao lado do tronco, sem balan√ßo.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-barbell-curl-side.gif' },
      { id: 'd_desenvolvimento', nome: 'Desenvolvimento Militar', musculos: 'Ombros, tr√≠ceps', descricao: 'Empurre acima da cabe√ßa sem perder estabilidade do core.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Barbell-standing-military-press-side.gif' },
      { id: 'd_elevacao_lateral', nome: 'Eleva√ß√£o Lateral', musculos: 'Deltoide lateral', descricao: 'Suba at√© a linha do ombro com cotovelos semi-flexionados.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-dumbbell-lateral-raise-side.gif' },
      { id: 'd_encolhimento', nome: 'Encolhimento (halteres/barra)', musculos: 'Trap√©zio', descricao: 'Eleve os ombros para cima e des√ßa controlando.', media: 'https://media.musclewiki.com/media/uploads/videos/branded/male-Dumbbells-dumbbell-shrug-side.gif' },
      { id: 'b_prancha', nome: 'Prancha Isom√©trica', musculos: 'Core', descricao: 'Alinhe cabe√ßa, tronco e quadril sem compensar lombar.', media: 'https://media.tenor.com/oqfD8WmKu14AAAAC/plank-fitness.gif' }
    ];

    const ACTIVE_REST_TIPS = [
      'Respira√ß√£o: 4 segundos inspirando pelo nariz e 4 soltando lentamente.',
      'Postura: retraia as esc√°pulas por 15 segundos e relaxe.',
      'Alongue peitoral em uma parede por 20 segundos de cada lado.',
      'Mobilize tornozelos: joelho √† frente sem tirar o calcanhar do ch√£o.',
      'Alongamento de flexor do quadril por 20 segundos de cada lado.',
      'Ative o core: contraia abd√¥men por 10 segundos e solte.'
    ];

    const EXERCISE_LIBRARY_MAP = Object.fromEntries(EXERCISE_LIBRARY.map((exercise) => [exercise.id, exercise]));

    const listEl = document.getElementById('exerciseList');
    const daySelectorEl = document.getElementById('daySelector');
    const dayTitleEl = document.getElementById('dayTitle');
    const dayFocusEl = document.getElementById('dayFocus');
    const resetDayBtn = document.getElementById('resetDayBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    const timerDisplayEl = document.getElementById('timerDisplay');
    const minutesInputEl = document.getElementById('minutesInput');
    const secondsInputEl = document.getElementById('secondsInput');
    const setTimerBtn = document.getElementById('setTimerBtn');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');
    const notifyPermissionBtn = document.getElementById('notifyPermissionBtn');
    const scheduleReminderBtn = document.getElementById('scheduleReminderBtn');
    const activeRestTextEl = document.getElementById('activeRestText');

    const exerciseLibraryEl = document.getElementById('exerciseLibrary');

    const customExerciseNameEl = document.getElementById('customExerciseName');
    const customExerciseMusclesEl = document.getElementById('customExerciseMuscles');
    const customExerciseDescEl = document.getElementById('customExerciseDesc');
    const customExerciseMediaEl = document.getElementById('customExerciseMedia');
    const addCustomExerciseBtn = document.getElementById('addCustomExerciseBtn');

    const calendarMonthLabelEl = document.getElementById('calendarMonthLabel');
    const calendarGridEl = document.getElementById('calendarGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const todayMonthBtn = document.getElementById('todayMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const markTodayBtn = document.getElementById('markTodayBtn');

    const retroYearLabelEl = document.getElementById('retroYearLabel');
    const retroSummaryEl = document.getElementById('retroSummary');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const currentYearBtn = document.getElementById('currentYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');
    const offlineStatusEl = document.getElementById('offlineStatus');
    const workoutProgressTextEl = document.getElementById('workoutProgressText');
    const workoutProgressFillEl = document.getElementById('workoutProgressFill');
    const nextWorkoutHintEl = document.getElementById('nextWorkoutHint');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFileInput = document.getElementById('importFileInput');
    const backupStatusEl = document.getElementById('backupStatus');
    const toggleSessionBtn = document.getElementById('toggleSessionBtn');
    const sessionStatusEl = document.getElementById('sessionStatus');
    const smartNudgeEl = document.getElementById('smartNudge');
    const coachQuickTextEl = document.getElementById('coachQuickText');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const shareWorkoutBtn = document.getElementById('shareWorkoutBtn');
    const libraryFilterInput = document.getElementById('libraryFilterInput');
    const toggleFavoritesOnlyBtn = document.getElementById('toggleFavoritesOnlyBtn');
    const weekPlanGridEl = document.getElementById('weekPlanGrid');
    const weekPlanHintEl = document.getElementById('weekPlanHint');
    const themeColorMetaEl = document.getElementById('themeColorMeta');

    let cargas = loadCargas();
    let activeDay = loadActiveDay();
    let trainingHistory = loadTrainingHistory();
    let customExercisesByDay = loadCustomExercises();
    let seriesTrackByDate = loadSeriesTrack();
    let workoutSetLog = loadWorkoutSetLog();
    let isSessionActive = false;
    let sessionExercises = [];
    let sessionIndex = 0;
    let favoriteExerciseIds = loadFavoriteExerciseIds();
    let activeTheme = loadTheme();
    let libraryFilterText = '';
    let favoritesOnly = false;

    const DAY_SEQUENCE = ['A', 'B', 'C', 'D'];

    const today = new Date();
    let calendarYear = today.getFullYear();
    let calendarMonth = today.getMonth();
    let retrospectiveYear = today.getFullYear();

    let totalSeconds = 90;
    let remainingSeconds = totalSeconds;
    let timerId = null;
    let reminderTimeoutId = null;

    function loadCargas() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch {
        return {};
      }
    }

    function saveCargas() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cargas));
    }

    function loadActiveDay() {
      const saved = localStorage.getItem(ACTIVE_DAY_KEY);
      if (saved && PLANOS[saved]) return saved;
      return 'A';
    }

    function saveActiveDay() {
      localStorage.setItem(ACTIVE_DAY_KEY, activeDay);
    }

    function loadTrainingHistory() {
      try {
        const raw = localStorage.getItem(TRAINING_HISTORY_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};

        const cleaned = {};
        Object.entries(parsed).forEach(([dateKey, dayValue]) => {
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateKey) && typeof dayValue === 'string' && PLANOS[dayValue]) {
            cleaned[dateKey] = dayValue;
          }
        });
        return cleaned;
      } catch {
        return {};
      }
    }

    function saveTrainingHistory() {
      localStorage.setItem(TRAINING_HISTORY_KEY, JSON.stringify(trainingHistory));
    }

    function loadCustomExercises() {
      try {
        const raw = localStorage.getItem(CUSTOM_EXERCISES_KEY);
        if (!raw) return { A: [], B: [], C: [], D: [] };
        const parsed = JSON.parse(raw);
        const base = { A: [], B: [], C: [], D: [] };
        Object.keys(base).forEach((day) => {
          const list = Array.isArray(parsed?.[day]) ? parsed[day] : [];
          base[day] = list
            .filter((item) => item && typeof item.id === 'string' && typeof item.nome === 'string')
            .map((item) => ({
              id: item.id,
              nome: item.nome,
              reps: typeof item.reps === 'string' ? item.reps : '10-12 reps',
              nota: typeof item.nota === 'string' ? item.nota : '',
              musculos: typeof item.musculos === 'string' ? item.musculos : '',
              descricao: typeof item.descricao === 'string' ? item.descricao : '',
              media: typeof item.media === 'string' ? item.media : ''
            }));
        });
        return base;
      } catch {
        return { A: [], B: [], C: [], D: [] };
      }
    }

    function saveCustomExercises() {
      localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(customExercisesByDay));
    }

    function loadSeriesTrack() {
      try {
        const raw = localStorage.getItem(SERIES_TRACK_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch {
        return {};
      }
    }

    function saveSeriesTrack() {
      localStorage.setItem(SERIES_TRACK_KEY, JSON.stringify(seriesTrackByDate));
    }

    function loadWorkoutSetLog() {
      try {
        const raw = localStorage.getItem(WORKOUT_SET_LOG_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};

        const cleaned = {};
        Object.entries(parsed).forEach(([dateKey, byExercise]) => {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey) || !byExercise || typeof byExercise !== 'object') return;

          const exerciseMap = {};
          Object.entries(byExercise).forEach(([exerciseId, weights]) => {
            if (!Array.isArray(weights)) return;
            const normalized = weights
              .map((weight) => Number(weight))
              .filter((weight) => Number.isFinite(weight) && weight >= 0);
            if (normalized.length) {
              exerciseMap[exerciseId] = normalized;
            }
          });

          if (Object.keys(exerciseMap).length) {
            cleaned[dateKey] = exerciseMap;
          }
        });

        return cleaned;
      } catch {
        return {};
      }
    }

    function saveWorkoutSetLog() {
      localStorage.setItem(WORKOUT_SET_LOG_KEY, JSON.stringify(workoutSetLog));
    }

    function loadFavoriteExerciseIds() {
      try {
        const raw = localStorage.getItem(FAVORITES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.filter((value) => typeof value === 'string');
      } catch {
        return [];
      }
    }

    function saveFavoriteExerciseIds() {
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favoriteExerciseIds));
    }

    function isFavoriteExercise(exerciseId) {
      return favoriteExerciseIds.includes(exerciseId);
    }

    function toggleFavoriteExercise(exerciseId) {
      if (isFavoriteExercise(exerciseId)) {
        favoriteExerciseIds = favoriteExerciseIds.filter((id) => id !== exerciseId);
      } else {
        favoriteExerciseIds = [...favoriteExerciseIds, exerciseId];
      }
      saveFavoriteExerciseIds();
      renderExerciseLibrary();
    }

    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') return saved;
      return 'dark';
    }

    function saveTheme() {
      localStorage.setItem(THEME_KEY, activeTheme);
    }

    function applyTheme() {
      document.body.setAttribute('data-theme', activeTheme);
      themeToggleBtn.textContent = activeTheme === 'dark' ? 'Tema: Escuro' : 'Tema: Claro';
      if (themeColorMetaEl) {
        themeColorMetaEl.setAttribute('content', activeTheme === 'dark' ? '#0f172a' : '#f8fafc');
      }
    }

    function loadLastInactivityAlertDate() {
      const value = localStorage.getItem(INACTIVITY_ALERT_KEY);
      return /^\d{4}-\d{2}-\d{2}$/.test(value || '') ? value : null;
    }

    function saveLastInactivityAlertDate(dateKey) {
      localStorage.setItem(INACTIVITY_ALERT_KEY, dateKey);
    }

    function toDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateKey(dateKey) {
      const [year, month, day] = dateKey.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatMonthYear(year, month) {
      return new Intl.DateTimeFormat('pt-BR', {
        month: 'long',
        year: 'numeric'
      }).format(new Date(year, month, 1));
    }

    function markTraining(dateKey, day) {
      trainingHistory[dateKey] = day;
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
      renderWorkoutStatus();
      renderWeekPlan();
    }

    function toggleTraining(dateKey) {
      if (trainingHistory[dateKey]) {
        delete trainingHistory[dateKey];
      } else {
        trainingHistory[dateKey] = activeDay;
      }
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
      renderWorkoutStatus();
      renderWeekPlan();
    }

    function parseBlockSeriesTarget(title) {
      const match = String(title || '').match(/(\d+)\s*(s√©ries|series|voltas?)/i);
      if (!match) return 3;
      return Math.max(1, Number(match[1]) || 3);
    }

    function formatWeight(value) {
      const numeric = Number(value);
      if (!Number.isFinite(numeric)) return '0';
      return numeric.toLocaleString('pt-BR', {
        minimumFractionDigits: Number.isInteger(numeric) ? 0 : 1,
        maximumFractionDigits: 2
      });
    }

    function getProgressionIncrement(exerciseName) {
      const normalized = String(exerciseName || '').toLowerCase();
      if (/halter|dumbbell/.test(normalized)) return 2.5;
      if (/barra|barbell|smith/.test(normalized)) return 5;
      return 2.5;
    }

    function getNextDay(day) {
      const index = DAY_SEQUENCE.indexOf(day);
      if (index < 0) return 'A';
      return DAY_SEQUENCE[(index + 1) % DAY_SEQUENCE.length];
    }

    function getLatestTrainingEntry() {
      const entries = Object.entries(trainingHistory)
        .filter(([, day]) => DAY_SEQUENCE.includes(day))
        .sort(([a], [b]) => a.localeCompare(b));
      if (!entries.length) return null;
      return entries[entries.length - 1];
    }

    function getCoachQuickText() {
      const focusText = PLANOS[activeDay]?.foco || 'Foco geral';
      const firstExercise = getCombinedExercises(activeDay)?.[0]?.exercicios?.[0];
      const details = firstExercise ? getExerciseDetails(firstExercise) : { descricao: '' };
      const tip = details.descricao || 'Mantenha execu√ß√£o controlada e respira√ß√£o ativa em todas as s√©ries.';
      return `Foco do dia: ${focusText} ‚Ä¢ Dica: ${tip}`;
    }

    function getNextWorkoutSuggestionText() {
      const latest = getLatestTrainingEntry();
      if (!latest) {
        return 'Pr√≥ximo treino sugerido: A';
      }

      const [dateKey, day] = latest;
      const nextDay = getNextDay(day);
      return `Pr√≥ximo treino sugerido: ${nextDay} ‚Ä¢ √öltimo: ${day} em ${formatDateKey(dateKey)}`;
    }

    function getWeekDayLabel(date) {
      const labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
      return labels[date.getDay()];
    }

    function getWeekStartDate(baseDate) {
      const date = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate());
      const day = date.getDay();
      const diffToMonday = day === 0 ? -6 : 1 - day;
      date.setDate(date.getDate() + diffToMonday);
      return date;
    }

    function getSuggestedDayForDate(date) {
      const latest = getLatestTrainingEntry();
      if (!latest) return 'A';

      const [dateKey, day] = latest;
      const lastDate = parseDateKey(dateKey);
      const diffDays = Math.floor((new Date(date.getFullYear(), date.getMonth(), date.getDate()) - new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate())) / (1000 * 60 * 60 * 24));
      if (diffDays <= 0) return day;

      let current = day;
      for (let i = 0; i < diffDays; i += 1) {
        current = getNextDay(current);
      }
      return current;
    }

    function renderWeekPlan() {
      weekPlanGridEl.innerHTML = '';

      const start = getWeekStartDate(new Date());
      const todayKey = toDateKey(new Date());
      let todaySuggestion = 'A';

      for (let offset = 0; offset < 7; offset += 1) {
        const date = new Date(start);
        date.setDate(start.getDate() + offset);
        const dateKey = toDateKey(date);
        const trainedDay = trainingHistory[dateKey];
        const suggestedDay = getSuggestedDayForDate(date);
        if (dateKey === todayKey) {
          todaySuggestion = suggestedDay;
        }

        const row = document.createElement('div');
        row.className = 'week-row';

        const dayLabel = document.createElement('div');
        dayLabel.className = 'week-day';
        dayLabel.textContent = getWeekDayLabel(date);

        const status = document.createElement('div');
        status.textContent = trainedDay ? `${trainedDay} ‚úì` : suggestedDay;

        const dateText = document.createElement('div');
        dateText.className = 'muted';
        dateText.textContent = formatDateKey(dateKey);

        row.append(dayLabel, status, dateText);
        weekPlanGridEl.appendChild(row);
      }

      weekPlanHintEl.textContent = `Hoje seria o treino ${todaySuggestion}.`;
    }

    function createWorkoutShareCanvasData() {
      const progress = getDayProgress(activeDay);
      const todayKey = toDateKey(new Date());
      const daySetMap = workoutSetLog?.[todayKey] || {};
      let volume = 0;

      Object.values(daySetMap).forEach((weights) => {
        if (!Array.isArray(weights)) return;
        volume += weights
          .map((weight) => Number(weight))
          .filter((weight) => Number.isFinite(weight) && weight >= 0)
          .reduce((sum, weight) => sum + weight, 0);
      });

      return {
        title: `Treino ${activeDay} conclu√≠do`,
        volume: `${formatWeight(volume)} kg`,
        progress: `${progress.done}/${progress.total} s√©ries`,
        time: formatTime(totalSeconds)
      };
    }

    function drawWorkoutShareImage() {
      const data = createWorkoutShareCanvasData();
      const canvas = document.createElement('canvas');
      canvas.width = 1080;
      canvas.height = 1080;
      const ctx = canvas.getContext('2d');
      if (!ctx) return null;

      ctx.fillStyle = activeTheme === 'light' ? '#f8fafc' : '#0f172a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = activeTheme === 'light' ? '#0f172a' : '#f8fafc';
      ctx.font = 'bold 72px system-ui';
      ctx.fillText('Meu Treino', 90, 170);

      ctx.font = 'bold 88px system-ui';
      ctx.fillText(data.title, 90, 340);

      ctx.font = '54px system-ui';
      ctx.fillText(`Volume: ${data.volume}`, 90, 500);
      ctx.fillText(`Progresso: ${data.progress}`, 90, 590);
      ctx.fillText(`Tempo: ${data.time}`, 90, 680);

      ctx.fillStyle = '#22c55e';
      ctx.font = 'bold 56px system-ui';
      ctx.fillText('üí™', 90, 790);

      return canvas;
    }

    async function shareWorkoutResult() {
      const canvas = drawWorkoutShareImage();
      if (!canvas) return;

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
      if (!blob) return;

      const file = new File([blob], `treino-${toDateKey(new Date())}.png`, { type: 'image/png' });
      if (navigator.canShare && navigator.share && navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: 'Meu Treino',
          text: `Treino ${activeDay} conclu√≠do üí™`,
          files: [file]
        });
        return;
      }

      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = file.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function getDayProgress(day, dateKey = toDateKey(new Date())) {
      const blocks = getCombinedExercises(day);
      const daySeries = seriesTrackByDate[dateKey] || {};

      let done = 0;
      let total = 0;

      blocks.forEach((block) => {
        const target = parseBlockSeriesTarget(block.titulo);
        block.exercicios.forEach((exercise) => {
          const completed = Number(daySeries[exercise.id] || 0);
          done += Math.min(completed, target);
          total += target;
        });
      });

      const percentage = total > 0 ? Math.round((done / total) * 100) : 0;
      return { done, total, percentage };
    }

    function getExercisesWithTargets(day) {
      const rows = [];
      getCombinedExercises(day).forEach((block) => {
        const targetSeries = parseBlockSeriesTarget(block.titulo);
        block.exercicios.forEach((exercise) => {
          rows.push({ exercise, targetSeries });
        });
      });
      return rows;
    }

    function isExerciseDoneToday(exerciseId, targetSeries) {
      return getSeriesCount(exerciseId) >= targetSeries;
    }

    function getCurrentSessionItem() {
      if (!isSessionActive) return null;
      return sessionExercises[sessionIndex] || null;
    }

    function recomputeSessionIndexToNextIncomplete() {
      const nextIndex = sessionExercises.findIndex((item) => !isExerciseDoneToday(item.exercise.id, item.targetSeries));
      sessionIndex = nextIndex >= 0 ? nextIndex : sessionExercises.length;
    }

    function updateSessionStatus() {
      if (!isSessionActive) {
        sessionStatusEl.textContent = 'Sess√£o: inativa';
        return;
      }

      const current = getCurrentSessionItem();
      if (!current) {
        sessionStatusEl.textContent = 'Sess√£o ativa ‚Ä¢ treino conclu√≠do ‚úÖ';
        return;
      }

      sessionStatusEl.textContent = `Sess√£o ativa ‚Ä¢ exerc√≠cio ${sessionIndex + 1}/${sessionExercises.length}: ${current.exercise.nome}`;
    }

    function scrollToCurrentSessionExercise() {
      const current = getCurrentSessionItem();
      if (!current) return;

      const targetEl = listEl.querySelector(`[data-exercise-id="${current.exercise.id}"]`);
      if (targetEl) {
        targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    function startSession() {
      isSessionActive = true;
      sessionExercises = getExercisesWithTargets(activeDay);
      recomputeSessionIndexToNextIncomplete();
      toggleSessionBtn.textContent = 'Encerrar sess√£o';
      renderExercises();
      setTimeout(scrollToCurrentSessionExercise, 40);
    }

    function stopSession() {
      isSessionActive = false;
      sessionExercises = [];
      sessionIndex = 0;
      toggleSessionBtn.textContent = 'Iniciar treino';
      renderExercises();
    }

    function startAutoRestTimer() {
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
      startTimer();
    }

    function maybeAdvanceSessionAfterSet(exerciseId) {
      if (!isSessionActive) return;
      const current = getCurrentSessionItem();
      if (!current || current.exercise.id !== exerciseId) return;
      if (isExerciseDoneToday(current.exercise.id, current.targetSeries)) {
        recomputeSessionIndexToNextIncomplete();
      }
    }

    function maybeShowInactivityNudge() {
      const todayKey = toDateKey(new Date());
      const latest = getLatestTrainingEntry();

      if (!latest) {
        smartNudgeEl.textContent = 'Sem treino registrado ainda: comece hoje com o treino A.';
        return;
      }

      const [dateKey, day] = latest;
      const now = new Date();
      const lastDate = parseDateKey(dateKey);
      const diffDays = Math.floor((new Date(now.getFullYear(), now.getMonth(), now.getDate()) - new Date(lastDate.getFullYear(), lastDate.getMonth(), lastDate.getDate())) / (1000 * 60 * 60 * 24));

      if (diffDays >= 2) {
        const message = `Hora de voltar. Seu √∫ltimo treino foi ${day}.`;
        smartNudgeEl.textContent = message;

        const lastAlertDate = loadLastInactivityAlertDate();
        if (lastAlertDate !== todayKey && 'Notification' in window && Notification.permission === 'granted') {
          new Notification('Lembrete inteligente', { body: message, icon: './icon.svg', badge: './icon.svg' });
          saveLastInactivityAlertDate(todayKey);
        }
      } else {
        smartNudgeEl.textContent = 'Consist√™ncia em dia. Continue no ritmo üí™';
      }
    }

    function recordSet(dateKey, exerciseId, weight) {
      if (!workoutSetLog[dateKey]) {
        workoutSetLog[dateKey] = {};
      }
      if (!Array.isArray(workoutSetLog[dateKey][exerciseId])) {
        workoutSetLog[dateKey][exerciseId] = [];
      }
      workoutSetLog[dateKey][exerciseId].push(Number.isFinite(weight) ? weight : 0);
    }

    function getExercisePRData(exerciseId) {
      const dates = Object.keys(workoutSetLog).sort();

      let lastWeight = null;
      let lastDate = null;
      let maxWeight = 0;
      let maxVolume = 0;

      dates.forEach((dateKey) => {
        const sets = workoutSetLog?.[dateKey]?.[exerciseId];
        if (!Array.isArray(sets) || !sets.length) return;

        const setNumbers = sets.map((weight) => Number(weight)).filter((weight) => Number.isFinite(weight));
        if (!setNumbers.length) return;

        const highestInDate = Math.max(...setNumbers);
        const volumeInDate = setNumbers.reduce((sum, weight) => sum + weight, 0);

        if (highestInDate > maxWeight) maxWeight = highestInDate;
        if (volumeInDate > maxVolume) maxVolume = volumeInDate;

        lastDate = dateKey;
        lastWeight = setNumbers[setNumbers.length - 1];
      });

      return {
        lastWeight,
        lastDate,
        maxWeight,
        maxVolume
      };
    }

    function formatDateKey(dateKey) {
      if (!dateKey) return '‚Äî';
      const [year, month, day] = dateKey.split('-');
      return `${day}/${month}/${year}`;
    }

    function renderWorkoutStatus() {
      const progress = getDayProgress(activeDay);
      workoutProgressTextEl.textContent = `Progresso: ${progress.done} / ${progress.total} s√©ries`;
      workoutProgressFillEl.style.width = `${progress.percentage}%`;
      nextWorkoutHintEl.textContent = getNextWorkoutSuggestionText();
      coachQuickTextEl.textContent = getCoachQuickText();
      updateSessionStatus();
      maybeShowInactivityNudge();
    }

    function renderCalendar() {
      calendarGridEl.innerHTML = '';
      calendarMonthLabelEl.textContent = formatMonthYear(calendarYear, calendarMonth);

      const weekdays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
      weekdays.forEach((name) => {
        const weekdayEl = document.createElement('div');
        weekdayEl.className = 'calendar-weekday';
        weekdayEl.textContent = name;
        calendarGridEl.appendChild(weekdayEl);
      });

      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      const startOffset = (firstDay.getDay() + 6) % 7;
      const todayKey = toDateKey(new Date());

      for (let i = 0; i < startOffset; i += 1) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        empty.setAttribute('aria-hidden', 'true');
        calendarGridEl.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day += 1) {
        const currentDate = new Date(calendarYear, calendarMonth, day);
        const dateKey = toDateKey(currentDate);
        const trainedDay = trainingHistory[dateKey];

        const dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className = 'calendar-day';
        dayBtn.dataset.date = dateKey;
        dayBtn.setAttribute('aria-label', trainedDay
          ? `${day} treinado (${trainedDay})`
          : `${day} sem treino marcado`);
        dayBtn.textContent = day;

        if (trainedDay) {
          dayBtn.classList.add('trained');
          const tag = document.createElement('span');
          tag.className = 'calendar-tag';
          tag.textContent = trainedDay;
          dayBtn.appendChild(tag);
        }

        if (dateKey === todayKey) {
          dayBtn.classList.add('today');
        }

        calendarGridEl.appendChild(dayBtn);
      }
    }

    function calculateStreaks(dateKeys) {
      if (!dateKeys.length) {
        return { longest: 0, latest: 0 };
      }

      let longest = 1;
      let current = 1;

      for (let i = 1; i < dateKeys.length; i += 1) {
        const prevDate = parseDateKey(dateKeys[i - 1]);
        const currentDate = parseDateKey(dateKeys[i]);
        const diffDays = Math.round((currentDate - prevDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          current += 1;
          if (current > longest) longest = current;
        } else {
          current = 1;
        }
      }

      return { longest, latest: current };
    }

    function createRetroItem(label, value) {
      const item = document.createElement('div');
      item.className = 'retro-item';

      const labelEl = document.createElement('div');
      labelEl.className = 'retro-label';
      labelEl.textContent = label;

      const valueEl = document.createElement('div');
      valueEl.className = 'retro-value';
      valueEl.textContent = value;

      item.append(labelEl, valueEl);
      return item;
    }

    function renderRetrospective() {
      retroSummaryEl.innerHTML = '';
      retroYearLabelEl.textContent = `Ano ${retrospectiveYear}`;

      const filteredEntries = Object.entries(trainingHistory)
        .filter(([dateKey]) => dateKey.startsWith(`${retrospectiveYear}-`))
        .sort(([a], [b]) => a.localeCompare(b));

      if (!filteredEntries.length) {
        retroSummaryEl.appendChild(createRetroItem('Resumo', 'Sem treinos neste ano'));
        return;
      }

      const total = filteredEntries.length;
      const monthCounts = Array(12).fill(0);
      const dayCounts = { A: 0, B: 0, C: 0, D: 0 };
      const retrospectiveIsCurrentYear = retrospectiveYear === new Date().getFullYear();

      let volumeTotalSets = 0;
      let tonnage = 0;

      filteredEntries.forEach(([dateKey, day]) => {
        const parsedDate = parseDateKey(dateKey);
        monthCounts[parsedDate.getMonth()] += 1;
        if (dayCounts[day] !== undefined) dayCounts[day] += 1;

        const daySetMap = workoutSetLog?.[dateKey] || {};
        Object.values(daySetMap).forEach((weights) => {
          if (!Array.isArray(weights)) return;
          const normalized = weights
            .map((weight) => Number(weight))
            .filter((weight) => Number.isFinite(weight) && weight >= 0);
          volumeTotalSets += normalized.length;
          tonnage += normalized.reduce((sum, weight) => sum + weight, 0);
        });
      });

      const bestMonthCount = Math.max(...monthCounts);
      const bestMonthIndex = monthCounts.indexOf(bestMonthCount);
      const bestMonthName = new Intl.DateTimeFormat('pt-BR', { month: 'long' })
        .format(new Date(retrospectiveYear, bestMonthIndex, 1));

      const streaks = calculateStreaks(filteredEntries.map(([dateKey]) => dateKey));
      const favoriteDay = Object.entries(dayCounts).sort((a, b) => b[1] - a[1])[0];
      const yearDays = retrospectiveIsCurrentYear
        ? Math.max(1, Math.floor((new Date() - new Date(retrospectiveYear, 0, 1)) / (1000 * 60 * 60 * 24)) + 1)
        : (new Date(retrospectiveYear, 1, 29).getMonth() === 1 ? 366 : 365);
      const totalWeeks = Math.max(1, yearDays / 7);
      const workoutsPerWeek = total / totalWeeks;
      const consistency = (total / yearDays) * 100;

      retroSummaryEl.appendChild(createRetroItem('Treinos totais', String(total)));
      retroSummaryEl.appendChild(createRetroItem('M√©dia mensal', (total / 12).toFixed(1)));
      retroSummaryEl.appendChild(createRetroItem('Melhor m√™s', `${bestMonthName} (${bestMonthCount})`));
      retroSummaryEl.appendChild(createRetroItem('Maior sequ√™ncia', `${streaks.longest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Sequ√™ncia recente', `${streaks.latest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Treino mais feito', `${favoriteDay[0]} (${favoriteDay[1]})`));
      retroSummaryEl.appendChild(createRetroItem('Volume total (s√©ries)', String(volumeTotalSets)));
      retroSummaryEl.appendChild(createRetroItem('Tonelagem', `${formatWeight(tonnage)} kg`));
      retroSummaryEl.appendChild(createRetroItem('Treinos/semana', workoutsPerWeek.toFixed(2)));
      retroSummaryEl.appendChild(createRetroItem('Consist√™ncia', `${consistency.toFixed(1)}%`));
    }

    function getCombinedExercises(day) {
      const baseBlocks = PLANOS[day].blocos;
      const customList = customExercisesByDay[day] || [];
      if (!customList.length) return baseBlocks;

      return [
        ...baseBlocks,
        {
          titulo: '5) Personalizados',
          meta: 'Exerc√≠cios adicionados por voc√™',
          exercicios: customList
        }
      ];
    }

    function getExerciseDetails(exercise) {
      const fromLibrary = EXERCISE_LIBRARY_MAP[exercise.id] || EXERCISE_LIBRARY.find((item) => item.nome === exercise.nome);
      return {
        musculos: exercise.musculos || fromLibrary?.musculos || '',
        descricao: exercise.descricao || fromLibrary?.descricao || exercise.nota || '',
        media: exercise.media || fromLibrary?.media || ''
      };
    }

    function openGoogleImagesSearch(exerciseName) {
      const query = encodeURIComponent(exerciseName);
      window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank', 'noopener,noreferrer');
    }

    function setOfflineStatus(text, state = 'pending') {
      offlineStatusEl.textContent = text;
      offlineStatusEl.classList.remove('pill-status-ready', 'pill-status-pending', 'pill-status-error');

      if (state === 'ready') {
        offlineStatusEl.classList.add('pill-status-ready');
      } else if (state === 'error') {
        offlineStatusEl.classList.add('pill-status-error');
      } else {
        offlineStatusEl.classList.add('pill-status-pending');
      }
    }

    async function requestOfflineStatusFromServiceWorker() {
      if (!('serviceWorker' in navigator)) {
        setOfflineStatus('Offline: sem suporte', 'error');
        return;
      }

      const controller = navigator.serviceWorker.controller;
      if (!controller) {
        setOfflineStatus(navigator.onLine ? 'Offline: preparando...' : 'Offline: indispon√≠vel', navigator.onLine ? 'pending' : 'error');
        return;
      }

      const channel = new MessageChannel();
      const timeoutId = setTimeout(() => {
        setOfflineStatus(navigator.onLine ? 'Offline: verificando...' : 'Offline: sem cache', navigator.onLine ? 'pending' : 'error');
      }, 1500);

      channel.port1.onmessage = (event) => {
        clearTimeout(timeoutId);
        if (event.data?.type === 'CACHE_STATUS') {
          if (event.data.ready) {
            setOfflineStatus('Offline: pronto', 'ready');
          } else {
            setOfflineStatus(navigator.onLine ? 'Offline: preparando...' : 'Offline: sem cache', navigator.onLine ? 'pending' : 'error');
          }
        }
      };

      controller.postMessage({ type: 'GET_CACHE_STATUS' }, [channel.port2]);
    }

    function getSeriesCount(exerciseId) {
      const todayKey = toDateKey(new Date());
      return Number(seriesTrackByDate?.[todayKey]?.[exerciseId] || 0);
    }

    function markSeries(exercise, targetSeries) {
      const todayKey = toDateKey(new Date());
      if (!seriesTrackByDate[todayKey]) {
        seriesTrackByDate[todayKey] = {};
      }

      const exerciseId = exercise.id;
      const current = Number(seriesTrackByDate[todayKey][exerciseId] || 0);
      const nextValue = current + 1;
      seriesTrackByDate[todayKey][exerciseId] = nextValue;

      const currentWeight = Number(cargas[exerciseId] || 0);
      recordSet(todayKey, exerciseId, currentWeight);

      saveSeriesTrack();
      saveWorkoutSetLog();

      if (nextValue === targetSeries && currentWeight > 0) {
        const increment = getProgressionIncrement(exercise.nome);
        const suggested = Number((currentWeight + increment).toFixed(2));
        const accepted = confirm(`Concluiu todas as s√©ries de ${exercise.nome}. Pr√≥ximo treino: +${formatWeight(increment)} kg?`);

        if (accepted) {
          cargas[exerciseId] = suggested;
          saveCargas();
        }
      }

      maybeAdvanceSessionAfterSet(exerciseId);

      if (isSessionActive) {
        startAutoRestTimer();
      }

      if ('vibrate' in navigator) {
        navigator.vibrate(80);
      }

      renderExercises();

      if (isSessionActive) {
        setTimeout(scrollToCurrentSessionExercise, 40);
      }
    }

    function buildCustomExerciseFromInput() {
      const nome = customExerciseNameEl.value.trim();
      const musculos = customExerciseMusclesEl.value.trim();
      const descricao = customExerciseDescEl.value.trim();
      const media = customExerciseMediaEl.value.trim();

      if (!nome) return null;

      return {
        id: `custom_${Date.now()}`,
        nome,
        reps: '10-12 reps',
        nota: '',
        musculos,
        descricao,
        media
      };
    }

    function addExerciseToActiveDay(exercise) {
      const day = activeDay;
      customExercisesByDay[day].push(exercise);
      saveCustomExercises();
      renderExercises();
    }

    function renderExerciseLibrary() {
      exerciseLibraryEl.innerHTML = '';

      const normalizedFilter = libraryFilterText.trim().toLowerCase();
      const filtered = EXERCISE_LIBRARY.filter((exercise) => {
        const inFavorites = !favoritesOnly || isFavoriteExercise(exercise.id);
        const searchText = `${exercise.nome} ${exercise.musculos}`.toLowerCase();
        const inSearch = !normalizedFilter || searchText.includes(normalizedFilter);
        return inFavorites && inSearch;
      });

      filtered.forEach((exercise) => {
        const card = document.createElement('div');
        card.className = 'block';

        const name = document.createElement('div');
        name.className = 'exercise-name';
        name.textContent = exercise.nome;
        name.classList.add('exercise-link');
        name.title = 'Abrir no Google Imagens';
        name.addEventListener('click', () => openGoogleImagesSearch(exercise.nome));

        const muscles = document.createElement('div');
        muscles.className = 'inline-chip';
        muscles.textContent = exercise.musculos;

        const description = document.createElement('div');
        description.className = 'exercise-meta';
        description.textContent = exercise.descricao;

        const actions = document.createElement('div');
        actions.className = 'exercise-actions';

        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'btn-secondary';
        addButton.textContent = `Adicionar ao treino ${activeDay}`;
        addButton.addEventListener('click', () => {
          addExerciseToActiveDay({
            id: `custom_${exercise.id}_${Date.now()}`,
            nome: exercise.nome,
            reps: '10-12 reps',
            nota: '',
            musculos: exercise.musculos,
            descricao: exercise.descricao,
            media: exercise.media
          });
        });

        const favButton = document.createElement('button');
        favButton.type = 'button';
        favButton.className = 'btn-favorite';
        favButton.textContent = isFavoriteExercise(exercise.id) ? '‚òÖ' : '‚òÜ';
        favButton.setAttribute('aria-label', `Favoritar ${exercise.nome}`);
        favButton.addEventListener('click', () => toggleFavoriteExercise(exercise.id));

        actions.append(addButton, favButton);
        card.append(name, muscles, description, actions);
        exerciseLibraryEl.appendChild(card);
      });

      if (!filtered.length) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Nenhum exerc√≠cio encontrado para esse filtro.';
        exerciseLibraryEl.appendChild(empty);
      }

      toggleFavoritesOnlyBtn.textContent = favoritesOnly ? 'Ver todos' : 'Ver s√≥ favoritos';
    }

    function setActiveRestTip(randomize = true) {
      const tip = randomize
        ? ACTIVE_REST_TIPS[Math.floor(Math.random() * ACTIVE_REST_TIPS.length)]
        : ACTIVE_REST_TIPS[0];
      activeRestTextEl.textContent = tip;
    }

    async function requestNotificationPermission() {
      if (!('Notification' in window)) return 'unsupported';
      if (Notification.permission === 'granted') return 'granted';
      const result = await Notification.requestPermission();
      return result;
    }

    function notifySmart(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: './icon.svg', badge: './icon.svg' });
      }
      if ('vibrate' in navigator) {
        navigator.vibrate([220, 120, 220]);
      }
    }

    function renderExercises() {
      listEl.innerHTML = '';
      const plano = PLANOS[activeDay];
      const blocks = getCombinedExercises(activeDay);

      dayTitleEl.textContent = plano.titulo;
      dayFocusEl.textContent = plano.foco;
      markTodayBtn.textContent = `Marcar treino de hoje (${activeDay})`;

      daySelectorEl.querySelectorAll('button').forEach((btn) => {
        const isActive = btn.dataset.day === activeDay;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });

      blocks.forEach((bloco) => {
        const blocoEl = document.createElement('div');
        blocoEl.className = 'block';

        const tituloEl = document.createElement('div');
        tituloEl.className = 'block-title';
        tituloEl.textContent = bloco.titulo;

        const metaEl = document.createElement('div');
        metaEl.className = 'block-meta';
        metaEl.textContent = bloco.meta;

        blocoEl.appendChild(tituloEl);
        blocoEl.appendChild(metaEl);

        bloco.exercicios.forEach((exercise) => {
          const targetSeries = parseBlockSeriesTarget(bloco.titulo);
          const prData = getExercisePRData(exercise.id);
          const details = getExerciseDetails(exercise);
          const row = document.createElement('div');
          row.className = 'row';
          row.dataset.exerciseId = exercise.id;

          const currentSessionItem = getCurrentSessionItem();
          if (isSessionActive && currentSessionItem && currentSessionItem.exercise.id === exercise.id) {
            row.classList.add('exercise-current');
          }

          const left = document.createElement('div');
          const name = document.createElement('div');
          name.className = 'exercise-name';
          name.textContent = exercise.nome;
          name.classList.add('exercise-link');
          name.title = 'Abrir no Google Imagens';
          name.addEventListener('click', () => openGoogleImagesSearch(exercise.nome));

          const meta = document.createElement('div');
          meta.className = 'exercise-meta';
          const descriptionText = details.descricao || exercise.nota;
          meta.textContent = `${exercise.reps}${descriptionText ? ` ‚Ä¢ ${descriptionText}` : ''}`;

          const prMeta = document.createElement('div');
          prMeta.className = 'exercise-meta pr-meta';
          const lastWeightText = prData.lastWeight !== null ? `${formatWeight(prData.lastWeight)} kg` : '‚Äî';
          const maxWeightText = prData.maxWeight > 0 ? `${formatWeight(prData.maxWeight)} kg üî•` : '‚Äî';
          const maxVolumeText = prData.maxVolume > 0 ? `${formatWeight(prData.maxVolume)} kg` : '‚Äî';
          const lastDateText = prData.lastDate ? formatDateKey(prData.lastDate) : '‚Äî';
          prMeta.textContent = `√öltimo: ${lastWeightText} ‚Ä¢ Recorde: ${maxWeightText} ‚Ä¢ Volume PR: ${maxVolumeText} ‚Ä¢ √öltima vez: ${lastDateText}`;

          const muscles = document.createElement('div');
          muscles.className = 'inline-chip';
          muscles.textContent = details.musculos || 'M√∫sculos gerais';

          const seriesRow = document.createElement('div');
          seriesRow.className = 'series-row';

          const seriesBadge = document.createElement('span');
          seriesBadge.className = 'muted';
          seriesBadge.textContent = `S√©ries hoje: ${getSeriesCount(exercise.id)} / ${targetSeries}`;

          const seriesButton = document.createElement('button');
          seriesButton.type = 'button';
          seriesButton.className = 'btn-series';
          seriesButton.textContent = '+ Marcar s√©rie';
          seriesButton.setAttribute('aria-label', `Marcar uma s√©rie em ${exercise.nome}`);
          seriesButton.addEventListener('click', () => markSeries(exercise, targetSeries));

          seriesRow.append(seriesButton, seriesBadge);

          left.append(name, muscles, meta, prMeta, seriesRow);

          const right = document.createElement('div');
          right.className = 'exercise-weight';

          const weightInput = document.createElement('input');
          weightInput.type = 'number';
          weightInput.min = '0';
          weightInput.step = '0.5';
          weightInput.inputMode = 'decimal';
          weightInput.setAttribute('aria-label', `Carga em kg para ${exercise.nome}`);
          weightInput.style.width = '90px';
          weightInput.value = typeof cargas[exercise.id] === 'number' ? cargas[exercise.id] : 0;
          weightInput.addEventListener('input', () => {
            const value = Number(weightInput.value);
            cargas[exercise.id] = Number.isNaN(value) ? 0 : value;
            saveCargas();
          });

          const plusLoadButton = document.createElement('button');
          plusLoadButton.type = 'button';
          plusLoadButton.className = 'btn-secondary';
          plusLoadButton.textContent = '+2,5';
          plusLoadButton.setAttribute('aria-label', `Adicionar 2,5kg em ${exercise.nome}`);
          plusLoadButton.addEventListener('click', () => {
            const currentWeight = Number(cargas[exercise.id] || 0);
            const nextWeight = Number((currentWeight + 2.5).toFixed(2));
            cargas[exercise.id] = nextWeight;
            saveCargas();
            renderExercises();
          });

          const kg = document.createElement('span');
          kg.textContent = 'kg';
          kg.className = 'muted';

          right.append(weightInput, plusLoadButton, kg);
          row.append(left, right);
          blocoEl.appendChild(row);
        });

        listEl.appendChild(blocoEl);
      });

      renderWorkoutStatus();
      renderWeekPlan();
    }

    function exportBackupData() {
      const payload = {
        version: 1,
        generatedAt: new Date().toISOString(),
        data: {
          cargas,
          activeDay,
          trainingHistory,
          customExercisesByDay,
          seriesTrackByDate,
          workoutSetLog,
          favoriteExerciseIds,
          activeTheme
        }
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      const dateLabel = toDateKey(new Date());
      link.href = url;
      link.download = `meu-treino-backup-${dateLabel}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      backupStatusEl.textContent = 'Backup exportado com sucesso.';
    }

    async function importBackupData(file) {
      if (!file) return;

      const text = await file.text();
      const parsed = JSON.parse(text);
      const data = parsed?.data || parsed;

      if (!data || typeof data !== 'object') {
        throw new Error('Arquivo inv√°lido');
      }

      if (data.cargas && typeof data.cargas === 'object') {
        cargas = data.cargas;
        saveCargas();
      }

      if (data.activeDay && PLANOS[data.activeDay]) {
        activeDay = data.activeDay;
        saveActiveDay();
      }

      if (data.trainingHistory && typeof data.trainingHistory === 'object') {
        trainingHistory = data.trainingHistory;
        saveTrainingHistory();
      }

      if (data.customExercisesByDay && typeof data.customExercisesByDay === 'object') {
        customExercisesByDay = data.customExercisesByDay;
        saveCustomExercises();
      }

      if (data.seriesTrackByDate && typeof data.seriesTrackByDate === 'object') {
        seriesTrackByDate = data.seriesTrackByDate;
        saveSeriesTrack();
      }

      if (data.workoutSetLog && typeof data.workoutSetLog === 'object') {
        workoutSetLog = data.workoutSetLog;
        saveWorkoutSetLog();
      }

      if (Array.isArray(data.favoriteExerciseIds)) {
        favoriteExerciseIds = data.favoriteExerciseIds.filter((value) => typeof value === 'string');
        saveFavoriteExerciseIds();
      }

      if (data.activeTheme === 'dark' || data.activeTheme === 'light') {
        activeTheme = data.activeTheme;
        saveTheme();
        applyTheme();
      }

      renderExercises();
      renderExerciseLibrary();
      renderCalendar();
      renderRetrospective();
      renderWeekPlan();

      backupStatusEl.textContent = 'Backup importado com sucesso.';
    }

    function resetCurrentDayLoads() {
      const blocos = getCombinedExercises(activeDay);
      blocos.forEach((bloco) => {
        bloco.exercicios.forEach((exercise) => {
          cargas[exercise.id] = 0;
        });
      });
      saveCargas();
      renderExercises();
    }

    function resetAllLoads() {
      cargas = {};
      saveCargas();
      renderExercises();
    }

    daySelectorEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-day]');
      if (!button) return;
      activeDay = button.dataset.day;
      saveActiveDay();

      if (isSessionActive) {
        sessionExercises = getExercisesWithTargets(activeDay);
        recomputeSessionIndexToNextIncomplete();
      }

      renderExercises();
      renderExerciseLibrary();
      renderWeekPlan();

      if (isSessionActive) {
        setTimeout(scrollToCurrentSessionExercise, 40);
      }
    });

    toggleSessionBtn.addEventListener('click', () => {
      if (isSessionActive) {
        stopSession();
      } else {
        startSession();
      }
    });

    resetDayBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas apenas do treino atual?')) {
        resetCurrentDayLoads();
      }
    });

    resetAllBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas de todos os treinos?')) {
        resetAllLoads();
      }
    });

    addCustomExerciseBtn.addEventListener('click', () => {
      const customExercise = buildCustomExerciseFromInput();
      if (!customExercise) {
        customExerciseNameEl.focus();
        return;
      }

      addExerciseToActiveDay(customExercise);
      customExerciseNameEl.value = '';
      customExerciseMusclesEl.value = '';
      customExerciseDescEl.value = '';
      customExerciseMediaEl.value = '';
    });

    themeToggleBtn.addEventListener('click', () => {
      activeTheme = activeTheme === 'dark' ? 'light' : 'dark';
      saveTheme();
      applyTheme();
    });

    shareWorkoutBtn.addEventListener('click', async () => {
      try {
        await shareWorkoutResult();
      } catch {
        notifySmart('Compartilhar resultado', 'N√£o foi poss√≠vel compartilhar agora.');
      }
    });

    libraryFilterInput.addEventListener('input', () => {
      libraryFilterText = libraryFilterInput.value || '';
      renderExerciseLibrary();
    });

    toggleFavoritesOnlyBtn.addEventListener('click', () => {
      favoritesOnly = !favoritesOnly;
      renderExerciseLibrary();
    });

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60).toString().padStart(2, '0');
      const sec = (seconds % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function updateTimerDisplay() {
      timerDisplayEl.textContent = formatTime(remainingSeconds);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      startPauseBtn.textContent = 'Iniciar';
    }

    function startTimer() {
      if (remainingSeconds <= 0) return;
      setActiveRestTip(true);
      timerId = setInterval(() => {
        remainingSeconds -= 1;
        updateTimerDisplay();

        if (remainingSeconds > 0 && remainingSeconds % 20 === 0) {
          setActiveRestTip(true);
        }

        if (remainingSeconds <= 0) {
          stopTimer();
          notifySmart('Descanso finalizado', 'Hora da pr√≥xima s√©rie.');
        }
      }, 1000);
      startPauseBtn.textContent = 'Pausar';
    }

    setTimerBtn.addEventListener('click', () => {
      const minuteStr = (minutesInputEl.value || '0').trim();
      const secondStr = (secondsInputEl.value || '0').trim();
      
      const parsedMinutes = parseInt(minuteStr, 10);
      const parsedSeconds = parseInt(secondStr, 10);

      const minutes = !isNaN(parsedMinutes)
        ? Math.max(0, Math.min(59, parsedMinutes))
        : 0;
      const seconds = !isNaN(parsedSeconds)
        ? Math.max(0, Math.min(59, parsedSeconds))
        : 0;

      totalSeconds = minutes * 60 + seconds;
      if (totalSeconds === 0) totalSeconds = 60;
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
    })

    startPauseBtn.addEventListener('click', () => {
      if (timerId) {
        stopTimer();
      } else {
        startTimer();
      }
    });

    resetTimerBtn.addEventListener('click', () => {
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
      setActiveRestTip(false);
    });

    notifyPermissionBtn.addEventListener('click', async () => {
      const permission = await requestNotificationPermission();
      if (permission === 'granted') {
        notifyPermissionBtn.textContent = 'Notifica√ß√µes ativas ‚úÖ';
        notifySmart('Notifica√ß√µes ativas', 'Voc√™ receber√° alertas do timer e lembretes.');
      } else if (permission === 'denied') {
        notifyPermissionBtn.textContent = 'Notifica√ß√µes bloqueadas';
      } else if (permission === 'unsupported') {
        notifyPermissionBtn.textContent = 'Sem suporte no navegador';
      }
    });

    scheduleReminderBtn.addEventListener('click', async () => {
      if (reminderTimeoutId) {
        clearTimeout(reminderTimeoutId);
      }

      await requestNotificationPermission();

      reminderTimeoutId = setTimeout(() => {
        notifySmart('Lembrete de treino', 'Hora de treinar. Se j√° treinou, √≥timo trabalho üí™');
      }, 60 * 60 * 1000);

      scheduleReminderBtn.textContent = 'Lembrete agendado ‚úÖ';
    });

    exportDataBtn.addEventListener('click', () => {
      try {
        exportBackupData();
      } catch {
        backupStatusEl.textContent = 'Erro ao exportar backup.';
      }
    });

    importDataBtn.addEventListener('click', () => {
      importFileInput.value = '';
      importFileInput.click();
    });

    importFileInput.addEventListener('change', async () => {
      const [file] = importFileInput.files || [];
      if (!file) return;
      try {
        await importBackupData(file);
      } catch {
        backupStatusEl.textContent = 'Arquivo inv√°lido ou corrompido.';
      }
    });

    calendarGridEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-date]');
      if (!button) return;
      toggleTraining(button.dataset.date);
    });

    prevMonthBtn.addEventListener('click', () => {
      calendarMonth -= 1;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear -= 1;
      }
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      calendarMonth += 1;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear += 1;
      }
      renderCalendar();
    });

    todayMonthBtn.addEventListener('click', () => {
      const now = new Date();
      calendarYear = now.getFullYear();
      calendarMonth = now.getMonth();
      renderCalendar();
    });

    markTodayBtn.addEventListener('click', () => {
      markTraining(toDateKey(new Date()), activeDay);
      renderWeekPlan();
    });

    prevYearBtn.addEventListener('click', () => {
      retrospectiveYear -= 1;
      renderRetrospective();
    });

    nextYearBtn.addEventListener('click', () => {
      retrospectiveYear += 1;
      renderRetrospective();
    });

    currentYearBtn.addEventListener('click', () => {
      retrospectiveYear = new Date().getFullYear();
      renderRetrospective();
    });

    applyTheme();
    renderExercises();
    renderExerciseLibrary();
    renderWeekPlan();
    setActiveRestTip(false);
    updateTimerDisplay();
    renderCalendar();
    renderRetrospective();

    window.addEventListener('online', () => {
      requestOfflineStatusFromServiceWorker();
    });

    window.addEventListener('offline', () => {
      requestOfflineStatusFromServiceWorker();
    });

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(() => {
          requestOfflineStatusFromServiceWorker();
        });
      });
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        requestOfflineStatusFromServiceWorker();
      });
    } else {
      setOfflineStatus('Offline: sem suporte', 'error');
    }
  </script>
</body>
</html>
