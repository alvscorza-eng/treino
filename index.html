<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Meu Treino" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon.svg" />
  <title>Meu Treino</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f8fafc;
      --muted: #94a3b8;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #334155;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 16px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-right: max(16px, env(safe-area-inset-right));
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      padding-left: max(16px, env(safe-area-inset-left));
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }

    h1, h2 {
      margin: 0 0 12px;
      line-height: 1.2;
    }

    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.1rem; color: var(--muted); }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .exercise-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .exercise-weight {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #0b1220;
      color: var(--text);
      font-size: 1rem;
      min-height: 44px;
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      touch-action: manipulation;
    }

    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn-primary { background: var(--accent); color: #052e16; }
    .btn-secondary { background: #334155; color: var(--text); }
    .btn-danger { background: var(--danger); color: #fff; }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .muted { color: var(--muted); font-size: 0.9rem; }

    .timer-display {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 8px 0 12px;
      letter-spacing: 1px;
    }

    .timer-inputs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }

    .add-form {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .pill {
      background: #0b1220;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      display: inline-block;
      margin-bottom: 8px;
    }

    .day-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }

    .day-btn {
      background: #334155;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .day-btn.active {
      background: var(--accent);
      color: #052e16;
      border-color: var(--accent);
    }

    .block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      background: #0b1220;
    }

    .block-title {
      font-size: 0.98rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .block-meta {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .exercise-meta {
      color: var(--muted);
      font-size: 0.86rem;
      line-height: 1.3;
    }

    .section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .calendar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
      margin-top: 8px;
    }

    .calendar-weekday {
      text-align: center;
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 600;
      padding: 4px 0;
    }

    .calendar-day {
      border: 1px solid var(--border);
      border-radius: 10px;
      min-height: 46px;
      background: #0b1220;
      color: var(--text);
      font-weight: 600;
      display: grid;
      place-items: center;
      position: relative;
      padding: 4px;
    }

    .calendar-day.empty {
      background: transparent;
      border-style: dashed;
      opacity: 0.35;
    }

    .calendar-day.trained {
      border-color: var(--accent);
      background: #123120;
      color: #dcfce7;
    }

    .calendar-day.today {
      outline: 2px solid #60a5fa;
      outline-offset: 1px;
    }

    .calendar-tag {
      position: absolute;
      right: 4px;
      bottom: 3px;
      font-size: 0.65rem;
      color: var(--muted);
    }

    .retro-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .retro-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b1220;
      padding: 10px;
    }

    .retro-label {
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 4px;
    }

    .retro-value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    @media (max-width: 400px) {
      .row {
        grid-template-columns: 1fr;
      }
      .exercise-weight {
        justify-content: flex-start;
      }
      .retro-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Meu Treino</h1>
      <span class="pill">Salvo no celular automaticamente</span>
      <h2>ABCD - 45 minutos</h2>

      <div class="day-selector" id="daySelector" aria-label="Seleção de treino por dia">
        <button class="day-btn" data-day="A" aria-label="Treino A">A</button>
        <button class="day-btn" data-day="B" aria-label="Treino B">B</button>
        <button class="day-btn" data-day="C" aria-label="Treino C">C</button>
        <button class="day-btn" data-day="D" aria-label="Treino D">D</button>
      </div>

      <p id="dayTitle" class="exercise-name"></p>
      <p id="dayFocus" class="muted"></p>
      <div id="exerciseList"></div>

      <div class="section-actions">
        <button id="resetDayBtn" class="btn-secondary">Resetar cargas do treino</button>
        <button id="resetAllBtn" class="btn-danger">Resetar todas as cargas</button>
      </div>
      <p class="muted">Edite os pesos em cada exercício. Salvamento automático.</p>
    </div>

    <div class="card">
      <h2>Timer de descanso</h2>
      <div id="timerDisplay" class="timer-display" role="timer" aria-live="polite" aria-atomic="true">01:30</div>

      <div class="timer-inputs">
        <label for="minutesInput" class="sr-only">Minutos</label>
        <input id="minutesInput" type="text" inputmode="numeric" value="1" title="Minutos" aria-label="Minutos" placeholder="Min" />
        <label for="secondsInput" class="sr-only">Segundos</label>
        <input id="secondsInput" type="text" inputmode="numeric" value="30" title="Segundos" aria-label="Segundos" placeholder="Seg" />
      </div>

      <div class="actions">
        <button id="setTimerBtn" class="btn-secondary">Definir tempo</button>
        <button id="startPauseBtn" class="btn-primary">Iniciar</button>
        <button id="resetTimerBtn" class="btn-danger">Resetar</button>
      </div>
      <p class="muted">Formato: minutos e segundos.</p>
    </div>

    <div class="card">
      <h2>Calendário de treinos</h2>
      <div class="calendar-head">
        <span id="calendarMonthLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevMonthBtn" class="btn-secondary" aria-label="Mês anterior">◀</button>
          <button id="todayMonthBtn" class="btn-secondary">Hoje</button>
          <button id="nextMonthBtn" class="btn-secondary" aria-label="Próximo mês">▶</button>
        </div>
      </div>
      <div id="calendarGrid" class="calendar-grid" role="grid" aria-label="Calendário de treino"></div>
      <div class="actions">
        <button id="markTodayBtn" class="btn-primary">Marcar treino de hoje</button>
      </div>
      <p class="muted">Toque em um dia para marcar/desmarcar. Salvo automaticamente.</p>
    </div>

    <div class="card">
      <h2>Retrospectiva anual</h2>
      <div class="calendar-head">
        <span id="retroYearLabel" class="exercise-name"></span>
        <div class="calendar-nav">
          <button id="prevYearBtn" class="btn-secondary" aria-label="Ano anterior">◀</button>
          <button id="currentYearBtn" class="btn-secondary">Ano atual</button>
          <button id="nextYearBtn" class="btn-secondary" aria-label="Próximo ano">▶</button>
        </div>
      </div>
      <div id="retroSummary" class="retro-grid"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'meuTreinoCargasV2';
    const ACTIVE_DAY_KEY = 'meuTreinoDiaAtivoV1';
    const TRAINING_HISTORY_KEY = 'meuTreinoHistoricoV1';

    const PLANOS = {
      A: {
        titulo: 'Treino A: Pernas Completo',
        foco: 'Quadríceps, posterior e panturrilha. Alta intensidade com supersets e drop set.',
        blocos: [
          {
            titulo: '1) Bloco de Força (Superset) - 4 séries',
            meta: 'Descanso: 60-90s',
            exercicios: [
              { id: 'a_agachamento', nome: 'Agachamento Livre ou Smith', reps: '8-10 reps', nota: 'Carga pesada e boa amplitude.' },
              { id: 'a_extensora', nome: 'Cadeira Extensora', reps: '12-15 reps', nota: 'Drop set na última série.' }
            ]
          },
          {
            titulo: '2) Bloco Posterior (Superset) - 3 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'a_stiff', nome: 'Stiff (halteres ou barra)', reps: '10-12 reps', nota: 'Coluna neutra e descida controlada.' },
              { id: 'a_flexora', nome: 'Mesa Flexora ou Flexora Vertical', reps: '12 reps', nota: 'Foco no alongamento do posterior.' }
            ]
          },
          {
            titulo: '3) Bloco de Pressão - 3 séries',
            meta: 'Descanso: 90s',
            exercicios: [
              { id: 'a_legpress', nome: 'Leg Press 45°', reps: '10 pesada + 10 média + 10 leve', nota: 'Sem descanso nas trocas de carga.' }
            ]
          },
          {
            titulo: '4) Finalização (Superset) - 3 séries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'a_panturrilha_pe', nome: 'Panturrilha em pé', reps: '15-20 reps', nota: '' },
              { id: 'a_adutora', nome: 'Cadeira Adutora', reps: '15 reps', nota: 'Concentração máxima na contração.' }
            ]
          }
        ]
      },
      B: {
        titulo: 'Treino B: Costas, Tríceps e Abs',
        foco: 'Estratégia puxar/empurrar com supersets para densidade e eficiência.',
        blocos: [
          {
            titulo: '1) Os Gigantes (Superset) - 4 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_barra_fixa', nome: 'Barra Fixa ou Graviton', reps: '8-10 reps ou limite', nota: 'Controle total do movimento.' },
              { id: 'b_dips', nome: 'Mergulho nas Paralelas (Dips)', reps: '10-12 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Densidade e Volume (Superset) - 3 séries',
            meta: 'Descanso: 60s',
            exercicios: [
              { id: 'b_remada', nome: 'Remada Curvada', reps: '10 reps', nota: 'Esmagar escápulas no pico.' },
              { id: 'b_triceps_testa', nome: 'Tríceps Testa', reps: '12 reps', nota: 'Drop set na 3ª série.' }
            ]
          },
          {
            titulo: '3) Isolamento (Superset) - 3 séries',
            meta: 'Descanso: 45s',
            exercicios: [
              { id: 'b_pulldown_estendido', nome: 'Pulldown com braços estendidos', reps: '15 reps', nota: '' },
              { id: 'b_triceps_corda', nome: 'Tríceps Corda', reps: '12-15 reps', nota: 'Abrir bem a corda no final.' }
            ]
          },
          {
            titulo: '4) Core (Circuito) - 3 voltas',
            meta: 'Descanso: 30s entre voltas',
            exercicios: [
              { id: 'b_elevacao_pernas', nome: 'Elevação de Pernas', reps: '15 reps', nota: '' },
              { id: 'b_reza_cabo', nome: 'Abdominal Reza (cabo)', reps: '15-20 reps', nota: '' },
              { id: 'b_prancha', nome: 'Prancha Isométrica', reps: '45s', nota: '' }
            ]
          }
        ]
      },
      C: {
        titulo: 'Treino C: Peito e Bíceps',
        foco: 'Hipertrofia e densidade muscular.',
        blocos: [
          {
            titulo: '1) Bloco de Volume (Peito) - 4 séries',
            meta: 'Superset sem descanso entre exercícios',
            exercicios: [
              { id: 'c_supino_inclinado', nome: 'Supino Inclinado (Halteres)', reps: '8-10 reps', nota: '' },
              { id: 'c_flexao', nome: 'Flexão de Braço', reps: 'Até a falha', nota: 'Executar logo após o supino.' }
            ]
          },
          {
            titulo: '2) Bloco de Força (Peito) - 3 séries',
            meta: 'Drop set na última série',
            exercicios: [
              { id: 'c_supino_reto', nome: 'Supino Reto (Barra ou Máquina)', reps: '10 reps', nota: 'Reduzir ~30% e ir até falha no final.' }
            ]
          },
          {
            titulo: '3) Isolamento e Pico (Superset) - 3 séries',
            meta: '',
            exercicios: [
              { id: 'c_pec_deck', nome: 'Crucifixo Máquina (Pec Deck)', reps: '12-15 reps', nota: 'Peito estufado no movimento.' },
              { id: 'c_rosca_direta', nome: 'Rosca Direta (Barra W/Reta)', reps: '10-12 reps', nota: 'Evitar balanço de tronco.' }
            ]
          },
          {
            titulo: '4) Finalizador Bíceps - 3 séries',
            meta: '',
            exercicios: [
              { id: 'c_rosca_martelo', nome: 'Rosca Martelo (Halteres)', reps: '12 reps', nota: '' },
              { id: 'c_rosca_concentrada', nome: 'Rosca Concentrada', reps: '10 reps', nota: 'Sem descanso entre braços.' }
            ]
          }
        ]
      },
      D: {
        titulo: 'Treino D: Ombros, Trapézio, Abs e Panturrilhas',
        foco: 'Largura de ombros (V-taper) e finalização de membros inferiores.',
        blocos: [
          {
            titulo: '1) Bloco de Largura (Ombros) - 4 séries',
            meta: '',
            exercicios: [
              { id: 'd_desenvolvimento', nome: 'Desenvolvimento Militar', reps: '8-10 reps', nota: '' },
              { id: 'd_elevacao_lateral', nome: 'Elevação Lateral', reps: '12-15 reps', nota: '' }
            ]
          },
          {
            titulo: '2) Detalhamento (Posterior/Trapézio) - 3 séries',
            meta: 'Drop set no encolhimento na última série',
            exercicios: [
              { id: 'd_posterior', nome: 'Elevação Lateral Inclinado', reps: '12 reps', nota: 'Posterior de ombro.' },
              { id: 'd_encolhimento', nome: 'Encolhimento (halteres/barra)', reps: '15 reps', nota: 'Segurar 2s no topo.' }
            ]
          },
          {
            titulo: '3) Core (Abs) - 3 séries',
            meta: '',
            exercicios: [
              { id: 'd_infra', nome: 'Abdominal Infra', reps: '15-20 reps', nota: 'Movimento lento e controlado.' },
              { id: 'd_supra', nome: 'Abdominal Supra (com peso)', reps: '15 reps', nota: 'Soltar ar no topo da contração.' }
            ]
          },
          {
            titulo: '4) Panturrilha - 4 séries',
            meta: 'Rest-pause na última série',
            exercicios: [
              { id: 'd_panturrilha_pe', nome: 'Panturrilha em pé', reps: '15-20 reps', nota: '' },
              { id: 'd_panturrilha_sentado', nome: 'Panturrilha sentado (cavalinho)', reps: '15 reps', nota: 'Falhou, descansa 10s e continua.' }
            ]
          }
        ]
      }
    };

    const listEl = document.getElementById('exerciseList');
    const daySelectorEl = document.getElementById('daySelector');
    const dayTitleEl = document.getElementById('dayTitle');
    const dayFocusEl = document.getElementById('dayFocus');
    const resetDayBtn = document.getElementById('resetDayBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');

    const timerDisplayEl = document.getElementById('timerDisplay');
    const minutesInputEl = document.getElementById('minutesInput');
    const secondsInputEl = document.getElementById('secondsInput');
    const setTimerBtn = document.getElementById('setTimerBtn');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const resetTimerBtn = document.getElementById('resetTimerBtn');

    const calendarMonthLabelEl = document.getElementById('calendarMonthLabel');
    const calendarGridEl = document.getElementById('calendarGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const todayMonthBtn = document.getElementById('todayMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const markTodayBtn = document.getElementById('markTodayBtn');

    const retroYearLabelEl = document.getElementById('retroYearLabel');
    const retroSummaryEl = document.getElementById('retroSummary');
    const prevYearBtn = document.getElementById('prevYearBtn');
    const currentYearBtn = document.getElementById('currentYearBtn');
    const nextYearBtn = document.getElementById('nextYearBtn');

    let cargas = loadCargas();
    let activeDay = loadActiveDay();
    let trainingHistory = loadTrainingHistory();

    const today = new Date();
    let calendarYear = today.getFullYear();
    let calendarMonth = today.getMonth();
    let retrospectiveYear = today.getFullYear();

    let totalSeconds = 90;
    let remainingSeconds = totalSeconds;
    let timerId = null;

    function loadCargas() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};
        return parsed;
      } catch {
        return {};
      }
    }

    function saveCargas() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cargas));
    }

    function loadActiveDay() {
      const saved = localStorage.getItem(ACTIVE_DAY_KEY);
      if (saved && PLANOS[saved]) return saved;
      return 'A';
    }

    function saveActiveDay() {
      localStorage.setItem(ACTIVE_DAY_KEY, activeDay);
    }

    function loadTrainingHistory() {
      try {
        const raw = localStorage.getItem(TRAINING_HISTORY_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') return {};

        const cleaned = {};
        Object.entries(parsed).forEach(([dateKey, dayValue]) => {
          if (/^\d{4}-\d{2}-\d{2}$/.test(dateKey) && typeof dayValue === 'string' && PLANOS[dayValue]) {
            cleaned[dateKey] = dayValue;
          }
        });
        return cleaned;
      } catch {
        return {};
      }
    }

    function saveTrainingHistory() {
      localStorage.setItem(TRAINING_HISTORY_KEY, JSON.stringify(trainingHistory));
    }

    function toDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateKey(dateKey) {
      const [year, month, day] = dateKey.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatMonthYear(year, month) {
      return new Intl.DateTimeFormat('pt-BR', {
        month: 'long',
        year: 'numeric'
      }).format(new Date(year, month, 1));
    }

    function markTraining(dateKey, day) {
      trainingHistory[dateKey] = day;
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
    }

    function toggleTraining(dateKey) {
      if (trainingHistory[dateKey]) {
        delete trainingHistory[dateKey];
      } else {
        trainingHistory[dateKey] = activeDay;
      }
      saveTrainingHistory();
      renderCalendar();
      renderRetrospective();
    }

    function renderCalendar() {
      calendarGridEl.innerHTML = '';
      calendarMonthLabelEl.textContent = formatMonthYear(calendarYear, calendarMonth);

      const weekdays = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
      weekdays.forEach((name) => {
        const weekdayEl = document.createElement('div');
        weekdayEl.className = 'calendar-weekday';
        weekdayEl.textContent = name;
        calendarGridEl.appendChild(weekdayEl);
      });

      const firstDay = new Date(calendarYear, calendarMonth, 1);
      const daysInMonth = new Date(calendarYear, calendarMonth + 1, 0).getDate();
      const startOffset = (firstDay.getDay() + 6) % 7;
      const todayKey = toDateKey(new Date());

      for (let i = 0; i < startOffset; i += 1) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        empty.setAttribute('aria-hidden', 'true');
        calendarGridEl.appendChild(empty);
      }

      for (let day = 1; day <= daysInMonth; day += 1) {
        const currentDate = new Date(calendarYear, calendarMonth, day);
        const dateKey = toDateKey(currentDate);
        const trainedDay = trainingHistory[dateKey];

        const dayBtn = document.createElement('button');
        dayBtn.type = 'button';
        dayBtn.className = 'calendar-day';
        dayBtn.dataset.date = dateKey;
        dayBtn.setAttribute('aria-label', trainedDay
          ? `${day} treinado (${trainedDay})`
          : `${day} sem treino marcado`);
        dayBtn.textContent = day;

        if (trainedDay) {
          dayBtn.classList.add('trained');
          const tag = document.createElement('span');
          tag.className = 'calendar-tag';
          tag.textContent = trainedDay;
          dayBtn.appendChild(tag);
        }

        if (dateKey === todayKey) {
          dayBtn.classList.add('today');
        }

        calendarGridEl.appendChild(dayBtn);
      }
    }

    function calculateStreaks(dateKeys) {
      if (!dateKeys.length) {
        return { longest: 0, latest: 0 };
      }

      let longest = 1;
      let current = 1;

      for (let i = 1; i < dateKeys.length; i += 1) {
        const prevDate = parseDateKey(dateKeys[i - 1]);
        const currentDate = parseDateKey(dateKeys[i]);
        const diffDays = Math.round((currentDate - prevDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          current += 1;
          if (current > longest) longest = current;
        } else {
          current = 1;
        }
      }

      return { longest, latest: current };
    }

    function createRetroItem(label, value) {
      const item = document.createElement('div');
      item.className = 'retro-item';

      const labelEl = document.createElement('div');
      labelEl.className = 'retro-label';
      labelEl.textContent = label;

      const valueEl = document.createElement('div');
      valueEl.className = 'retro-value';
      valueEl.textContent = value;

      item.append(labelEl, valueEl);
      return item;
    }

    function renderRetrospective() {
      retroSummaryEl.innerHTML = '';
      retroYearLabelEl.textContent = `Ano ${retrospectiveYear}`;

      const filteredEntries = Object.entries(trainingHistory)
        .filter(([dateKey]) => dateKey.startsWith(`${retrospectiveYear}-`))
        .sort(([a], [b]) => a.localeCompare(b));

      if (!filteredEntries.length) {
        retroSummaryEl.appendChild(createRetroItem('Resumo', 'Sem treinos neste ano'));
        return;
      }

      const total = filteredEntries.length;
      const monthCounts = Array(12).fill(0);
      const dayCounts = { A: 0, B: 0, C: 0, D: 0 };

      filteredEntries.forEach(([dateKey, day]) => {
        const parsedDate = parseDateKey(dateKey);
        monthCounts[parsedDate.getMonth()] += 1;
        if (dayCounts[day] !== undefined) dayCounts[day] += 1;
      });

      const bestMonthCount = Math.max(...monthCounts);
      const bestMonthIndex = monthCounts.indexOf(bestMonthCount);
      const bestMonthName = new Intl.DateTimeFormat('pt-BR', { month: 'long' })
        .format(new Date(retrospectiveYear, bestMonthIndex, 1));

      const streaks = calculateStreaks(filteredEntries.map(([dateKey]) => dateKey));
      const favoriteDay = Object.entries(dayCounts).sort((a, b) => b[1] - a[1])[0];

      retroSummaryEl.appendChild(createRetroItem('Treinos totais', String(total)));
      retroSummaryEl.appendChild(createRetroItem('Média mensal', (total / 12).toFixed(1)));
      retroSummaryEl.appendChild(createRetroItem('Melhor mês', `${bestMonthName} (${bestMonthCount})`));
      retroSummaryEl.appendChild(createRetroItem('Maior sequência', `${streaks.longest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Sequência recente', `${streaks.latest} dias`));
      retroSummaryEl.appendChild(createRetroItem('Treino mais feito', `${favoriteDay[0]} (${favoriteDay[1]})`));
    }

    function renderExercises() {
      listEl.innerHTML = '';
      const plano = PLANOS[activeDay];

      dayTitleEl.textContent = plano.titulo;
      dayFocusEl.textContent = plano.foco;
      markTodayBtn.textContent = `Marcar treino de hoje (${activeDay})`;

      daySelectorEl.querySelectorAll('button').forEach((btn) => {
        const isActive = btn.dataset.day === activeDay;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });

      plano.blocos.forEach((bloco) => {
        const blocoEl = document.createElement('div');
        blocoEl.className = 'block';

        const tituloEl = document.createElement('div');
        tituloEl.className = 'block-title';
        tituloEl.textContent = bloco.titulo;

        const metaEl = document.createElement('div');
        metaEl.className = 'block-meta';
        metaEl.textContent = bloco.meta;

        blocoEl.appendChild(tituloEl);
        blocoEl.appendChild(metaEl);

        bloco.exercicios.forEach((exercise) => {
          const row = document.createElement('div');
          row.className = 'row';

          const left = document.createElement('div');
          const name = document.createElement('div');
          name.className = 'exercise-name';
          name.textContent = exercise.nome;

          const meta = document.createElement('div');
          meta.className = 'exercise-meta';
          meta.textContent = `${exercise.reps}${exercise.nota ? ` • ${exercise.nota}` : ''}`;

          left.append(name, meta);

          const right = document.createElement('div');
          right.className = 'exercise-weight';

          const weightInput = document.createElement('input');
          weightInput.type = 'number';
          weightInput.min = '0';
          weightInput.step = '0.5';
          weightInput.inputMode = 'decimal';
          weightInput.setAttribute('aria-label', `Carga em kg para ${exercise.nome}`);
          weightInput.style.width = '90px';
          weightInput.value = typeof cargas[exercise.id] === 'number' ? cargas[exercise.id] : 0;
          weightInput.addEventListener('input', () => {
            const value = Number(weightInput.value);
            cargas[exercise.id] = Number.isNaN(value) ? 0 : value;
            saveCargas();
          });

          const kg = document.createElement('span');
          kg.textContent = 'kg';
          kg.className = 'muted';

          right.append(weightInput, kg);
          row.append(left, right);
          blocoEl.appendChild(row);
        });

        listEl.appendChild(blocoEl);
      });
    }

    function resetCurrentDayLoads() {
      const plano = PLANOS[activeDay];
      plano.blocos.forEach((bloco) => {
        bloco.exercicios.forEach((exercise) => {
          cargas[exercise.id] = 0;
        });
      });
      saveCargas();
      renderExercises();
    }

    function resetAllLoads() {
      cargas = {};
      saveCargas();
      renderExercises();
    }

    daySelectorEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-day]');
      if (!button) return;
      activeDay = button.dataset.day;
      saveActiveDay();
      renderExercises();
    });

    resetDayBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas apenas do treino atual?')) {
        resetCurrentDayLoads();
      }
    });

    resetAllBtn.addEventListener('click', () => {
      if (confirm('Resetar todas as cargas de todos os treinos?')) {
        resetAllLoads();
      }
    });

    function formatTime(seconds) {
      const min = Math.floor(seconds / 60).toString().padStart(2, '0');
      const sec = (seconds % 60).toString().padStart(2, '0');
      return `${min}:${sec}`;
    }

    function updateTimerDisplay() {
      timerDisplayEl.textContent = formatTime(remainingSeconds);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      startPauseBtn.textContent = 'Iniciar';
    }

    function startTimer() {
      if (remainingSeconds <= 0) return;
      timerId = setInterval(() => {
        remainingSeconds -= 1;
        updateTimerDisplay();

        if (remainingSeconds <= 0) {
          stopTimer();
          if ('vibrate' in navigator) {
            navigator.vibrate([250, 150, 250]);
          }
          alert('Tempo finalizado!');
        }
      }, 1000);
      startPauseBtn.textContent = 'Pausar';
    }

    setTimerBtn.addEventListener('click', () => {
      const minuteStr = (minutesInputEl.value || '0').trim();
      const secondStr = (secondsInputEl.value || '0').trim();
      
      const parsedMinutes = parseInt(minuteStr, 10);
      const parsedSeconds = parseInt(secondStr, 10);

      const minutes = !isNaN(parsedMinutes)
        ? Math.max(0, Math.min(59, parsedMinutes))
        : 0;
      const seconds = !isNaN(parsedSeconds)
        ? Math.max(0, Math.min(59, parsedSeconds))
        : 0;

      totalSeconds = minutes * 60 + seconds;
      if (totalSeconds === 0) totalSeconds = 60;
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
    })

    startPauseBtn.addEventListener('click', () => {
      if (timerId) {
        stopTimer();
      } else {
        startTimer();
      }
    });

    resetTimerBtn.addEventListener('click', () => {
      remainingSeconds = totalSeconds;
      stopTimer();
      updateTimerDisplay();
    });

    calendarGridEl.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-date]');
      if (!button) return;
      toggleTraining(button.dataset.date);
    });

    prevMonthBtn.addEventListener('click', () => {
      calendarMonth -= 1;
      if (calendarMonth < 0) {
        calendarMonth = 11;
        calendarYear -= 1;
      }
      renderCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      calendarMonth += 1;
      if (calendarMonth > 11) {
        calendarMonth = 0;
        calendarYear += 1;
      }
      renderCalendar();
    });

    todayMonthBtn.addEventListener('click', () => {
      const now = new Date();
      calendarYear = now.getFullYear();
      calendarMonth = now.getMonth();
      renderCalendar();
    });

    markTodayBtn.addEventListener('click', () => {
      markTraining(toDateKey(new Date()), activeDay);
    });

    prevYearBtn.addEventListener('click', () => {
      retrospectiveYear -= 1;
      renderRetrospective();
    });

    nextYearBtn.addEventListener('click', () => {
      retrospectiveYear += 1;
      renderRetrospective();
    });

    currentYearBtn.addEventListener('click', () => {
      retrospectiveYear = new Date().getFullYear();
      renderRetrospective();
    });

    renderExercises();
    updateTimerDisplay();
    renderCalendar();
    renderRetrospective();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>
